import{a as z,d as R,e as W}from"./main-Bqfk0G7A.js";let v=null,I=null,C="",N="",k=!1,S=!1,T=[];function le(){Y(),X(),ee(),K()}function K(){document.querySelectorAll(".delete-category").forEach(n=>{n.addEventListener("click",()=>q(n))});const o=document.querySelector(".category-actions .btn-outline");o&&o.addEventListener("click",Q)}function Q(){const c=document.getElementById("category-container");if(!c)return;const o=c.querySelectorAll(".category-item").length;if(o>=9){window.showToast("카테고리는 최대 9개까지 추가할 수 있습니다.",3e3,"warning");return}const n=document.createElement("div");n.className="data_input category-item",n.innerHTML=`
    <p>카테고리${o+1}</p>
    <div class="category-input-group">
      <input type="text"/>
      <button type="button" class="btn-i delete-category">-</button>
    </div>
  `;const t=n.querySelector(".delete-category");t&&t.addEventListener("click",()=>q(t)),c.appendChild(n)}function q(c){var a;if(!document.getElementById("category-container"))return;const n=c.closest(".category-item");if(!n)return;const s=n.querySelector("input").value.trim(),i=(a=e==null?void 0:e.category)==null?void 0:a.find(d=>d.name===s),u=(i==null?void 0:i.item)||s.toLowerCase().replace(/\s+/g,"_");T.push({name:s,item:u,element:n}),n.remove()}function X(){const c=document.querySelector(".btn-outline");c&&c.addEventListener("click",o=>{o.preventDefault(),U()})}let e=null;async function Y(){try{const o=JSON.parse(localStorage.getItem("userInfo")||"{}").userId;if(!o)return;const t=await(await z(`/model_user_setting?func=get-user&userId=${o}`)).json();if(t&&t.user){e=t.user;const s=document.getElementById("storeNm");s&&(s.value=t.user.storeName||"");const i=document.querySelector("#tel-input");i&&(i.value=t.user.tel||"");const u=document.getElementById("businessNo");u&&(u.value=t.user.businessNo||"");const a=document.querySelector('.in-box input[type="text"]');a&&(a.value=t.user.limitCount||"");const d=document.querySelector("#wash-time-input");d&&(d.value=t.user.washTime||"");const g=document.querySelector("#remote-address");g&&(g.value=t.user.remoteAddress||"");const p=document.getElementById("point-check");p&&(p.checked=!t.user.payType);const w=document.getElementById("vcat-check");if(w&&(w.checked=t.user.vcat),Z(t.user.category||[]),t.user.logoUrl){const r=document.getElementById("logoPreview");r&&(r.src=t.user.logoUrl,r.style.display="block",r.onerror=()=>{r.style.display="none"})}else if(t.user.logoBase64){const r=document.getElementById("logoPreview");r&&(r.src=t.user.logoBase64,r.style.display="block")}if(t.user.iconUrl){const r=document.getElementById("iconPreview");r&&(r.src=t.user.iconUrl,r.style.display="block",r.onerror=()=>{r.style.display="none"})}else if(t.user.iconBase64){const r=document.getElementById("iconPreview");r&&(r.src=t.user.iconBase64,r.style.display="block")}}}catch{window.showToast("매장 정보 로드에 실패했습니다.",3e3,"error")}}function Z(c){const o=document.getElementById("category-container");if(!o)return;o.innerHTML="";const n=(c||[]).filter(t=>t&&t.no!=="0"&&t.item!=="all"&&t.item!=="0");n.length>0&&n.forEach(t=>{const s=String(t.item??""),i=document.createElement("div");i.className="data_input category-item",i.innerHTML=`
        <p>카테고리${s}</p>
        <div class="category-input-group">
          <input type="text" value="${t.name||""}" />
          <button type="button" class="btn-i delete-category">-</button>
        </div>
      `;const u=i.querySelector(".delete-category");u&&u.addEventListener("click",()=>q(u)),o.appendChild(i)})}async function U(){var c;try{const o=JSON.parse(localStorage.getItem("userInfo")||"{}");if(!localStorage.getItem("accessToken"))return;const t=o.userId||"zero001",s=document.querySelector("#storeNm"),i=document.querySelector("#tel-input"),u=document.getElementById("businessNo"),a=document.querySelector("#remote-address"),d=document.querySelector('input[type="password"]'),g=document.getElementById("limit-count"),p=document.getElementById("wash-time-input"),w=document.getElementById("point-check"),r=document.getElementById("vcat-check");let f=!1,L=!1,P=!1,B=!1;const O=document.querySelectorAll("#category-container .category-input-group input"),M=Array.from(O).map((l,y)=>{var F;const m=l.value.trim();if(!m)return null;const h=(F=e==null?void 0:e.category)==null?void 0:F.find(G=>G.name===m),$=(y+1).toString(),J=(h==null?void 0:h.item)||$;return{name:m,no:$,item:J}}).filter(l=>l!==null),E=[{name:"전체메뉴",no:"0",item:"all"},...M],x=(e==null?void 0:e.category)||[],_=T.length>0;if(E.length!==x.length||_)B=!0;else for(let l=0;l<E.length;l++){const y=E[l],m=x[l];if(!m||(y==null?void 0:y.name)!==m.name){B=!0;break}}if(s&&s.value!==(e==null?void 0:e.storeName)&&(f=!0),i&&i.value!==(e==null?void 0:e.tel)&&(f=!0),u&&u.value!==(e==null?void 0:e.businessNo)&&(f=!0),a&&a.value!==(e==null?void 0:e.remoteAddress)&&(f=!0),p&&p.value!==(e==null?void 0:e.washTime)&&(f=!0),w&&w.checked!==!(e!=null&&e.payType)&&(f=!0),r&&r.checked!==(e==null?void 0:e.vcat)&&(f=!0),d&&d.value!==""&&d.value!=="******"){if(d.value.length<6){window.showToast("비밀번호는 6자리 이상이어야 합니다.",3e3,"warning");return}L=!0}const b=(g==null?void 0:g.value)||"",A=((c=e==null?void 0:e.limitCount)==null?void 0:c.toString())||"";if(g&&b!==""&&b!==A&&(f=!0),(v||I||k||S)&&(P=!0),!f&&!L&&!P&&!B){window.showToast("변경사항이 없습니다.",3e3,"warning");return}if(f||P||B){_&&await D(t);const l={userId:t,adminId:t};s&&s.value!==(e==null?void 0:e.storeName)&&(l.storeName=s.value),i&&i.value!==(e==null?void 0:e.tel)&&(l.tel=i.value),u&&u.value!==(e==null?void 0:e.businessNo)&&(l.businessNo=u.value),a&&a.value!==(e==null?void 0:e.remoteAddress)&&(l.remoteAddress=a.value),p&&p.value!==(e==null?void 0:e.washTime)&&(l.washTime=p.value),w&&w.checked!==!(e!=null&&e.payType)&&(l.payType=!w.checked),r&&r.checked!==(e==null?void 0:e.vcat)&&(l.vcat=r.checked),g&&b!==""&&b!==A&&(l.limitCount=parseInt(b)),B&&E.length>0&&(l.category=E),v?(l.logoFileName=v.name,l.logoBase64=C):k&&(l.logoFileName="",l.logoBase64="",l.logoUrl=""),I?(l.iconFileName=I.name,l.iconBase64=N):S&&(l.iconFileName="",l.iconBase64="",l.iconUrl="");const y=await R("/model_user_setting?func=update-user",l),m=await y.json();(m.success||m.status==="success"||y.ok)&&await W("/model_machine_controll",{userId:t,func:"update-user"})}if(L){const l={userId:t,newPassword:d.value,adminId:t};await R("/model_user_setting?func=update-password",l)}window.showToast("변경사항이 저장되었습니다.",3e3,"success"),T=[],d&&(d.value="******"),v&&(v=null,C=""),I&&(I=null,N=""),k=!1,S=!1,e&&(k&&(e.logoUrl="",e.logoBase64=""),S&&(e.iconUrl="",e.iconBase64=""),B&&(e.category=E.map((l,y)=>{var m,h;return{...l,item:((h=(m=e==null?void 0:e.category)==null?void 0:m[y])==null?void 0:h.item)||l.name.toLowerCase().replace(/\s+/g,"_")}})))}catch{window.showToast("저장 중 오류가 발생했습니다.",3e3,"error")}}async function D(c){for(const o of T)try{console.log(`카테고리 ${o.name} 처리 시작`),console.log("전송할 데이터:",{userId:c,category:o.item,categoryName:o.name});const n=await z(`/model_user_setting?func=check-category-usage&userId=${c}&category=${o.item}`);if(console.log("응답:",n.status,n.ok),!n.ok)throw new Error(`카테고리 사용 여부 확인 실패: ${n.status}`);const t=await n.json();if(console.log("결과:",t),t.hasAny){console.log(`카테고리 ${o.name} 사용 중`);const s=await fetch("https://api.narrowroad-model.com/model_user_setting?func=move-category-to-all",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({userId:c,category:o.item})});if(console.log("응답:",s.status,s.ok),!s.ok)throw new Error(`카테고리 이동 실패: ${s.status}`);const i=await s.json();if(console.log("결과:",i),!i.success)throw new Error("카테고리 이동에 실패했습니다.")}else console.log(`카테고리 ${o.name} 사용되지 않음 - 바로 삭제`);console.log(`카테고리 ${o.name} 처리 완료`)}catch(n){console.error(`카테고리 ${o.name} 처리 중 오류:`,n);const t=document.getElementById("category-container");t&&(t.appendChild(o.element),t.querySelectorAll(".category-item").forEach((i,u)=>{const a=i.querySelector("p");a&&(a.textContent=`카테고리 ${u+1}`)})),window.showToast(`카테고리 ${o.name} 삭제 중 오류가 발생했습니다.`,3e3,"error")}}function ee(){const c=document.getElementById("logoUpload");c&&c.addEventListener("change",te);const o=document.getElementById("iconUpload");o&&o.addEventListener("change",oe);const n=document.querySelector(".icon-header button");n&&n.addEventListener("click",ne);const s=document.querySelectorAll(".icon-header button")[1];s&&s.addEventListener("click",ce)}function H(c,o,n){return new Promise(t=>{const s=new Image;s.onload=()=>{t(s.width<=o&&s.height<=n)},s.src=URL.createObjectURL(c)})}function V(c){return new Promise((o,n)=>{const t=new FileReader;t.onload=()=>{const i=t.result.split(",")[1];o(i)},t.onerror=n,t.readAsDataURL(c)})}function j(c){return new Promise((o,n)=>{const t=new FileReader;t.onload=()=>o(t.result),t.onerror=n,t.readAsDataURL(c)})}async function te(c){var i;const o=(i=c.target.files)==null?void 0:i[0];if(!o)return;if(o.size>2*1024*1024){window.showToast("파일 크기는 2MB 이하여야 합니다.",3e3,"warning");return}if(!await H(o,600,140)){window.showToast("로고 이미지는 600x140 이하여야 합니다.",3e3,"warning");return}v=o,C=await V(o),k=!1;const t=document.getElementById("fileName");t&&(t.textContent=o.name);const s=document.getElementById("logoPreview");if(s){const u=await j(o);s.src=u,s.style.display="block"}}async function oe(c){var i;const o=(i=c.target.files)==null?void 0:i[0];if(!o)return;if(o.size>2*1024*1024){window.showToast("파일 크기는 2MB 이하여야 합니다.",3e3,"warning");return}if(!await H(o,1300,2e3)){window.showToast("아이콘 이미지는 1300x2000 이하여야 합니다.",3e3,"warning");return}I=o,N=await V(o),S=!1;const t=document.getElementById("iconFileName");t&&(t.textContent=o.name);const s=document.getElementById("iconPreview");if(s){const u=await j(o);s.src=u,s.style.display="block"}}function ne(){if(!(e!=null&&e.logoUrl)&&!(e!=null&&e.logoBase64))return;v=null,C="",k=!0;const c=document.getElementById("logoUpload");c&&(c.value="");const o=document.getElementById("fileName");o&&(o.textContent="");const n=document.getElementById("logoPreview");n&&(n.src="",n.style.display="none"),e&&(e.logoUrl="",e.logoBase64="")}function ce(){if(!(e!=null&&e.iconUrl)&&!(e!=null&&e.iconBase64))return;I=null,N="",S=!0;const c=document.getElementById("iconUpload");c&&(c.value="");const o=document.getElementById("iconFileName");o&&(o.textContent="");const n=document.getElementById("iconPreview");n&&(n.src="",n.style.display="none"),e&&(e.iconUrl="",e.iconBase64="")}export{le as initNormalSet};
