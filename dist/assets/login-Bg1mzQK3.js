import{s as w}from"./main-Bhqf6MiU.js";const l="https://api.narrowroad-model.com";function S(){console.log("âœ… login.ts ë¡œë“œë¨"),localStorage.removeItem("accessToken"),localStorage.removeItem("userInfo");const n=document.getElementById("login-form");if(!n){console.error("âŒ ë¡œê·¸ì¸ í¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŒ");return}n.addEventListener("submit",async o=>{o.preventDefault(),localStorage.removeItem("accessToken"),localStorage.removeItem("userInfo"),console.log("ğŸ—‘ï¸ ê¸°ì¡´ ë¡œê·¸ì¸ í† í° ì‚­ì œë¨");const e=document.getElementById("adminId").value.trim(),t=document.getElementById("password").value.trim(),s=document.getElementById("agree").checked;if(!e||!t){alert("ì•„ì´ë””ì™€ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");return}window.showLoading();try{const r=await fetch(`${l}/model_admin_login?func=login`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({adminId:e,password:t})}),d=await r.json();r.ok?await k(d,s):alert(d.message||"ë¡œê·¸ì¸ ì‹¤íŒ¨. ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”.")}catch(r){console.error("âŒ ë¡œê·¸ì¸ ìš”ì²­ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:",r),alert("ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”.")}finally{window.hideLoading()}});const a=document.getElementById("kakao-login-btn");a&&a.addEventListener("click",y)}function y(){const n="240886095629b93f9655026145a39487",a="https://zeroadmin.kr/html/kakao-callback.html",o=new Uint8Array(16);crypto.getRandomValues(o);const e=Array.from(o).map(m=>m.toString(16).padStart(2,"0")).join("");sessionStorage.setItem("kakao_state",e);const t=`https://kauth.kakao.com/oauth/authorize?response_type=code&client_id=${encodeURIComponent(n)}&redirect_uri=${encodeURIComponent(a)}&state=${encodeURIComponent(e)}`,s=window.matchMedia("(max-width: 768px)").matches,r=document.getElementById("agree"),d=!!(r!=null&&r.checked),p=async m=>{if(m.origin!==window.location.origin)return;const g=m.data||{};if(g.type!=="kakao-auth")return;const h=sessionStorage.getItem("kakao_state");if(!h||g.state!==h){console.warn("Invalid state",{got:g.state,expected:h}),alert("ë¡œê·¸ì¸ ë³´ì•ˆ ê²€ì¦ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");return}const{code:f,error:u}=g;if(u||!f){console.error("âŒ Kakao OAuth error or code missing:",u),alert("ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸ ì‹¤íŒ¨. ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”.");return}try{const c=await fetch(`${l}/model_admin_login?func=kakao-login`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({code:f,state:h})}),i=await c.json();c.ok&&i.accessToken?await k(i,d):c.ok&&i.redirectUrl?window.location.href=i.redirectUrl:(console.error("âŒ ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸ ì‹¤íŒ¨ ì‘ë‹µ:",i),alert("ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸ ì‹¤íŒ¨. ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”."))}catch(c){console.error("âŒ ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸ ìš”ì²­ ì˜¤ë¥˜:",c),alert("ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”.")}};if(s){window.location.href=t;return}window.addEventListener("message",p,{once:!0}),window.open(t,"kakaoLogin","width=500,height=700")||(window.location.href=t)}async function k(n,a=!1){try{localStorage.setItem("accessToken",n.accessToken),a?(console.log("âœ… ë¡œê·¸ì¸ ì„±ê³µ â†’ ìë™ë¡œê·¸ì¸ í™œì„±í™”"),localStorage.setItem("refreshToken",n.refreshToken)):(console.log("âœ… ë¡œê·¸ì¸ ì„±ê³µ â†’ ìë™ë¡œê·¸ì¸ ì‚­ì œ"),localStorage.removeItem("refreshToken")),console.log("âœ… ë¡œê·¸ì¸ ì„±ê³µ â†’ í† í° ì €ì¥ ì™„ë£Œ!");const o=await fetch(`${l}/model_admin_login?func=me`,{method:"GET",headers:{"Content-Type":"application/json",Authorization:`Bearer ${n.accessToken}`},mode:"cors"});if(!o.ok){console.error("âŒ ì‚¬ìš©ì ì •ë³´ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:",o.status),alert("ìœ ì € ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");return}const e=await o.json();if(e.userId){const t=await fetch(`${l}/model_user_setting?func=get-user&userId=${e.userId}`,{method:"GET",headers:{"Content-Type":"application/json",Authorization:`Bearer ${n.accessToken}`},mode:"cors"});if(t.ok){const{user:s}=await t.json();w(s),console.log("âœ… ì‚¬ìš©ì ì •ë³´ ì €ì¥ ì™„ë£Œ")}else{const s=await t.text();console.error("âŒ ì‚¬ìš©ì ì •ë³´ ì¡°íšŒ ì‹¤íŒ¨:",t.status,s),alert("ì‚¬ìš©ì ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");return}}(e==null?void 0:e.grade)===3?window.location.href="/html/franchiseHome.html":(e==null?void 0:e.grade)===1||(e==null?void 0:e.grade)===2?window.location.href="/html/adminHome.html":window.location.href="/html/home.html"}catch(o){console.error("âŒ postLogin ì²˜ë¦¬ ì˜¤ë¥˜:",o),alert("ë¡œê·¸ì¸ í›„ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.")}}async function _(){if(localStorage.getItem("accessToken"))return!0;const a=localStorage.getItem("refreshToken");if(!a)return!1;const o=await fetch(`${l}/model_admin_login?func=refresh`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({refreshToken:a})});if(!o.ok)return localStorage.removeItem("refreshToken"),!1;const e=await o.json();return localStorage.setItem("accessToken",e.accessToken),!0}export{_ as bootstrapAuth,S as initLogin};
