var D=Object.defineProperty;var H=(t,e,o)=>e in t?D(t,e,{enumerable:!0,configurable:!0,writable:!0,value:o}):t[e]=o;var y=(t,e,o)=>H(t,typeof e!="symbol"?e+"":e,o);import{a as M,g as B,b as x,c as O,d as C,e as j}from"./main-BxrN5h5y.js";class J{constructor(e){y(this,"data");y(this,"pageSize");y(this,"blockSize");y(this,"container");y(this,"onPageChange");y(this,"currentPage");this.data=e.data,this.pageSize=e.pageSize||10,this.blockSize=e.blockSize||5,this.container=document.getElementById(e.containerId),this.onPageChange=e.onPageChange,this.currentPage=1,this.render(),this.movePage(1)}get totalPages(){return Math.ceil(this.data.length/this.pageSize)}render(){this.container.innerHTML="";const e=document.createElement("button");e.textContent="<",e.onclick=()=>this.moveBlock(-1),this.container.appendChild(e);for(let n=1;n<=this.totalPages;n++){const a=document.createElement("button");a.textContent=String(n),a.dataset.page=String(n),a.onclick=()=>this.movePage(n),this.container.appendChild(a)}const o=document.createElement("button");o.textContent=">",o.onclick=()=>this.moveBlock(1),this.container.appendChild(o),this.updateVisibleButtons()}movePage(e){if(e<1||e>this.totalPages)return;this.currentPage=e;const o=(e-1)*this.pageSize,n=o+this.pageSize,a=this.data.slice(o,n);this.onPageChange(a,e),this.updateActiveButton(),this.updateVisibleButtons()}moveBlock(e){const a=(Math.floor((this.currentPage-1)/this.blockSize)+e)*this.blockSize+1;a<1||a>this.totalPages||this.movePage(a)}updateActiveButton(){this.container.querySelectorAll("button").forEach(o=>{o.dataset.page&&o.classList.toggle("active",Number(o.dataset.page)===this.currentPage)})}updateVisibleButtons(){const e=this.container.querySelectorAll("button"),o=Math.floor((this.currentPage-1)/this.blockSize);e.forEach(n=>{if(!n.dataset.page)return;const a=Number(n.dataset.page),l=o*this.blockSize+1,i=l+this.blockSize-1;a>=l&&a<=i?n.style.display="inline-block":n.style.display="none"})}}function R({data:t,currentPage:e,limit:o,onPageChange:n,containerId:a}){const l=Math.ceil(t.total/o),i=t.pageKeys?JSON.parse(t.pageKeys):[],g=document.getElementById(a);if(!g)return;g.innerHTML="";const r=5;let p=Math.max(1,e-Math.floor(r/2)),c=p+r-1;c>l&&(c=l,p=Math.max(1,c-r+1));const m=document.createElement("button");m.innerHTML="&lt;",m.disabled=e===1,m.addEventListener("click",()=>{e>1&&n(e-1===1?null:i[e-3]||null,e-1)}),g.appendChild(m);for(let s=p;s<=c;s++){const u=document.createElement("button");u.setAttribute("data-page",String(s)),u.innerText=String(s),u.style.display="inline-block",s===e&&u.classList.add("active"),u.addEventListener("click",()=>{const w=s===1?null:i[s-2]||null;n(w,s)}),g.appendChild(u)}const d=document.createElement("button");d.innerHTML="&gt;",d.disabled=e===l,d.addEventListener("click",()=>{e<l&&n(i[e-1]||null,e+1)}),g.appendChild(d)}async function U(t){const e=await M(`/model_user_setting?func=get-user&userId=${t}`);if(!e.ok){const n=await e.json();return console.error("🔴 응답 본문:",n),alert("❌ 사용자 정보를 불러오지 못했습니다."),null}const{user:o}=await e.json();return o}let I=!1,b=[],v,V=1;const T=10;let E={},k=!1;async function Z(){const t=B();if(!t){window.showToast("사용자 정보가 없습니다.",2e3,"error");return}W((t==null?void 0:t.isPhone)??!0);const e=document.getElementById("popupTel");e&&_(e),document.getElementById("earnMileage").value=String(t.earnMileage??""),document.getElementById("mileageNumber").value=String(t.mileageNumber??""),document.getElementById("isPhone").checked=t.isPhone??!1;const o=document.getElementById("isPhone"),n=document.getElementById("mileageNumber");o&&n&&(o.addEventListener("change",()=>{o.checked?(n.value="11",n.disabled=!0,n.placeholder="휴대폰번호 11자리 고정"):(n.disabled=!1,n.value="",n.placeholder="4-12")}),o.checked&&(n.value="11",n.disabled=!0,n.placeholder="휴대폰번호 11자리 고정"));const a=document.getElementById("selectAllBtn");if(!a)return;a.addEventListener("click",function(){I=!I,document.querySelectorAll("input.row-checkbox").forEach(u=>{u.checked=I}),a.className=I?"btn-s mb10":"btn-s blue mb10",a.textContent=I?"전체해제":"전체선택"}),document.getElementById("pointInfoSave").addEventListener("click",async function(){await F()});const i=document.getElementById("searchNumber"),g=document.getElementById("searchButton"),r=document.getElementById("searchReset");g.addEventListener("click",()=>{const s=i.value.trim();if(!s){window.showToast("검색어를 입력해주세요.",2e3,"warning");return}const u=b.filter(w=>{var h,f;return((h=w.mileageNo)==null?void 0:h.includes(s))||((f=w.tel)==null?void 0:f.includes(s))});N(u)}),r.addEventListener("click",()=>{i.value="",N(b)}),document.querySelectorAll(".popupCloseBtn").forEach(s=>{s.addEventListener("click",()=>{A()})}),document.getElementById("saveButton").addEventListener("click",async()=>{k?await L("update"):await L("create")}),document.getElementById("createPointBtn").addEventListener("click",()=>{v=void 0,k=!1,q()});const d=document.getElementById("deleteButton");d&&d.addEventListener("click",async()=>{const s=document.querySelectorAll("input.row-checkbox:checked");if(s.length===0){window.showToast("삭제할 항목을 선택해주세요.",2e3,"warning");return}if(!confirm(`선택한 ${s.length}개 항목을 삭제하시겠습니까?`))return;const w=B();if(!w){window.showToast("사용자 정보가 없습니다.",2e3,"error");return}const h=w.userId;let f=0;for(const K of s){const S=K.dataset.id;if(!S)continue;(await x(`/model_admin_mileage?func=mileage-delete&userId=${h}&uniqueMileageNo=${S}`)).ok||(f++,console.error(`❌ 삭제 실패: ${S}`))}f>0?window.showToast(`❌ ${f}건 삭제 실패`,2e3,"error"):window.showToast("✅ 선택된 마일리지를 모두 삭제했습니다."),await $()}),await $()}async function q(){const t=document.querySelector(".popup-overlay");t.style.display="flex";const e=document.getElementById("saveButton");e.textContent=k?"수정":"저장",document.getElementById("mileageNo").value="",document.getElementById("popupTel").value="",document.getElementById("popupPassword").value="",document.getElementById("popupMileage").value="",document.getElementById("popupCount").value="",document.getElementById("popupAmount").value="",document.getElementById("myTextarea").value=""}function A(){const t=document.querySelector(".popup-overlay");t.style.display="none"}async function F(){const t=B();if(!t){window.showToast("사용자 정보가 없습니다.",2e3,"error");return}const e=await O(),o=e==null?void 0:e.adminId,n=parseInt(document.getElementById("earnMileage").value,10),a=parseInt(document.getElementById("mileageNumber").value,10),l=document.getElementById("isPhone");if(!n){window.showToast("마일리지 적립률을 입력해주세요.",2e3,"warning");return}if(100<n){window.showToast("마일리지 적립률은 0~100 사이로 입력해주세요.",2e3,"warning");return}if(!a){window.showToast("마일리지 적립 번호 자리수를 입력해주세요.",2e3,"warning");return}if(4>a||12<a){window.showToast("마일리지 적립번호 자리수는 4-12자리 이내로 입력해주세요.",2e3,"warning");return}const i={userId:t.userId,adminId:o,isPhone:l.checked,earnMileage:n,mileageNumber:a};if(!(await C("/model_user_setting?func=update-user",i)).ok){console.error("❌ 데이터 가져오기 실패");return}const r=await U(t.userId);r&&(localStorage.setItem("userInfo",JSON.stringify(r)),window.showToast("✅ 사용자 정보 저장 완료"))}async function $(){const t=B();if(!t){window.showToast("사용자 정보가 없습니다.",2e3,"error");return}const e=t.userId,o=await M(`/model_admin_mileage?userId=${e}&func=mileage&limit=1000`);if(!o.ok){console.error("❌ 데이터 가져오기 실패");return}b=(await o.json()).items||[],await N(b)}async function N(t){new J({data:t,pageSize:10,blockSize:5,containerId:"pagination",onPageChange:(e,o)=>{const n=document.querySelector("tbody"),a=document.getElementById("selectAllBtn");if(!n||!a)return;I=!1,a.textContent="전체선택",n.innerHTML="";const l=document.getElementById("popupAmount");l.addEventListener("click",()=>{l.value=l.value.replace(/[^0-9]/g,"")}),l.addEventListener("blur",()=>{const i=l.value.replace(/[^0-9]/g,"");i?l.value=Number(i).toLocaleString()+"p":l.value="0p"}),e.forEach((i,g)=>{const r=document.createElement("tr"),p=i.amount??0;r.innerHTML=`
                  <td><input type="checkbox" class="row-checkbox" data-id="${i.uniqueMileageNo}"></td>
                  <td>${g+1+(o-1)*10}</td>
                  <td>${P(i.mileageNo)}</td>
                  <td>${Number(p).toLocaleString()}p</td>
                  <td><button class="btn-delete" data-id="${i.uniqueMileageNo}">삭제</button></td>
                `,r.addEventListener("click",async m=>{const d=m.target;if(d.closest("input[type='checkbox']")||d.closest(".btn-delete"))return;const s=i;v=s,k=!0,await q();const u=await z(v,V),w=(u==null?void 0:u.total)||0;document.getElementById("popupCount").value=`${w}건`,document.getElementById("popupCount").readOnly=!0,document.getElementById("mileageNo").value=P(s.mileageNo??""),document.getElementById("popupTel").value=P(s.tel??""),document.getElementById("popupPassword").value=s.password??"",document.getElementById("popupMileage").value=String(Number(p).toLocaleString()??"0")+"p",document.getElementById("popupAmount").value=String(Number(p).toLocaleString()??"0")+"p",document.getElementById("myTextarea").value=s.note??""});const c=r.querySelector(".btn-delete");c.onclick=async()=>{if(!confirm("정말 삭제하시겠습니까?"))return;const d=B();if(!d){window.showToast("사용자 정보가 없습니다.",2e3,"error");return}const s=d.userId;if(!(await x(`/model_admin_mileage?userId=${s}&func=mileage-delete&uniqueMileageNo=${i.uniqueMileageNo}`)).ok){window.showToast("❌ 삭제 실패",2e3,"error");return}window.showToast("✅ 삭제 완료"),await $()},n.appendChild(r)})}})}async function L(t){try{const e=document.getElementById("mileageNo").value.trim(),o=document.getElementById("popupTel").value.trim(),n=document.getElementById("popupPassword").value.trim(),a=document.getElementById("popupAmount").value.trim(),l=a.replace(/[^0-9]/g,""),i=document.getElementById("myTextarea").value.trim(),g=B();if(!g){window.showToast("사용자 정보가 없습니다.",2e3,"error");return}const{userId:r,isPhone:p,mileageNumber:c}=g;if(!r||p===void 0||c===void 0){window.showToast(`📌 고객번호 설정이 누락되었습니다.
[휴대폰 여부 / 자릿수] 정보를 먼저 등록해주세요.`,2e3,"warning");return}const m=G(e,p,c);if(m){window.showToast(m,2e3,"warning");return}const d=p?e.replace(/-/g,""):e;if(t==="create"){const h=o?n?a?null:"포인트":"패스워드":"전화번호";if(h){window.showToast(`필수 항목 ${h} 를 입력해주세요.`,2e3,"warning");return}}else{const h=o?n?null:"패스워드":"전화번호";if(h){window.showToast(`필수 항목 ${h} 를 입력해주세요.`,2e3,"warning");return}}if(!/^\d+$/.test(n)){window.showToast("비밀번호는 숫자만 입력해주세요.",2e3,"warning");return}if(l&&!/^\d+$/.test(l)){window.showToast("포인트는 숫자만 입력해주세요.",2e3,"warning");return}const s={userId:r,mileageNo:d,password:n,points:l,tel:o};if(i&&(s.note=i),t==="update"){if(!(v!=null&&v.uniqueMileageNo)){window.showToast("선택된 항목이 없습니다.",2e3,"warning");return}s.uniqueMileageNo=v.uniqueMileageNo,s.newPassword=n,delete s.password}const u=t==="create"?`/model_admin_mileage?userId=${r}&func=mileage-add`:"/model_admin_mileage?func=mileage-update",w=t==="create"?await j(u,s):await C(u,s);if(!w.ok){try{const h=await w.json(),f=(h==null?void 0:h.message)??`${t==="create"?"등록":"수정"} 중 오류가 발생했습니다.`;window.showToast(`❌ ${f}`,2e3,"error")}catch{window.showToast(`❌ ${t==="create"?"등록":"수정"} 실패`,2e3,"error")}return}window.showToast(`✅ ${t==="create"?"등록":"수정"} 완료`),A(),await $()}catch(e){console.error(`❌ ${t} 오류:`,e),window.showToast(`서버 오류로 ${t==="create"?"등록":"수정"}에 실패했습니다.`,2e3,"error")}}async function z(t,e=1){const o=B();if(!o)return;const n=E[e-1];let a=`/model_admin_mileage?func=mileage-history&userId=${o.userId}&uniqueMileageNo=${t.uniqueMileageNo}&limit=${T}`;n&&(a+=`&lastEvaluatedKey=${encodeURIComponent(JSON.stringify(n))}`);const l=await M(a),{items:i,total:g,pageKeys:r}=await l.json();if(E={},r)try{JSON.parse(r).forEach((m,d)=>{E[d+1]=m})}catch(c){console.warn("⚠️ pageKeys 파싱 실패:",c)}const p=document.getElementById("historyTableBody");if(p)return p.innerHTML="",i.forEach((c,m)=>{const d=document.createElement("tr"),s=c.timestamp.split("T")[0],u=c.timestamp.split("T")[1].split(".")[0];d.innerHTML=`
            <td>${m+1+(e-1)*T}</td>
            <td>${s}</td>
            <td>${u}</td>
            <td>${Number(c.totalAmt??0).toLocaleString()}원</td>
            <td>${c.points}p</td>
            <td>${Number(c.amount).toLocaleString()}p</td>
        `,p.appendChild(d)}),R({data:{total:g,pageKeys:r},currentPage:e,limit:T,containerId:"historyPagination",onPageChange:(c,m)=>{E[m-1]=c,z(t,m)}}),{items:i,total:g}}function G(t,e,o){const n=t.trim(),a=e?n.replace(/-/g,""):n;return/^\d+$/.test(a)?a.length!==o?`포인트 번호는 ${o}자리여야 합니다.`:null:"포인트 번호는 숫자만 입력해주세요."}function W(t){const e=document.getElementById("mileageNo");e&&(e.value="",e.placeholder=t?"010-1234-5678":"숫자만 입력",e.addEventListener("input",o=>{let n=o.target.value.replace(/\D/g,"");t?_(e):e.value=n}))}function _(t){t.addEventListener("input",()=>{const e=t.value.replace(/\D/g,"").slice(0,11);e.length<=3?t.value=e:e.length<=7?t.value=`${e.slice(0,3)}-${e.slice(3)}`:t.value=`${e.slice(0,3)}-${e.slice(3,7)}-${e.slice(7)}`})}function P(t){const e=t.replace(/\D/g,"");if(e.startsWith("02")){if(e.length===9)return`${e.slice(0,2)}-${e.slice(2,5)}-${e.slice(5)}`;if(e.length===10)return`${e.slice(0,2)}-${e.slice(2,6)}-${e.slice(6)}`}return e.length===10?`${e.slice(0,3)}-${e.slice(3,6)}-${e.slice(6)}`:e.length===11?`${e.slice(0,3)}-${e.slice(3,7)}-${e.slice(7)}`:e}export{_ as applyPhoneInputFormat,Z as initPoint};
