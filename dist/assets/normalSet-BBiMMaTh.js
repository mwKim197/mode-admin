import{a as O,g as te,j as ne,k as oe,d as F,e as W,c as ce}from"./main-B39EgYpI.js";let E=null,S=null,_="",x="",C=!1,b=!1,T=[];function Ne(){me(),le(),ke(),se()}function se(){document.querySelectorAll(".delete-category").forEach(n=>{n.addEventListener("click",()=>R(n))});const e=document.querySelector(".category-actions .btn-outline");e&&e.addEventListener("click",re)}function re(){const c=document.getElementById("category-container");if(!c)return;const e=c.querySelectorAll(".category-item").length;if(e>=9){window.showToast("카테고리는 최대 9개까지 추가할 수 있습니다.",3e3,"warning");return}const n=document.createElement("div");n.className="data_input category-item",n.innerHTML=`
    <p>카테고리${e+1}</p>
    <div class="category-input-group">
      <input type="text"/>
      <button type="button" class="btn-i delete-category">-</button>
    </div>
  `;const o=n.querySelector(".delete-category");o&&o.addEventListener("click",()=>R(o)),c.appendChild(n)}function R(c){var u;if(!document.getElementById("category-container"))return;const n=c.closest(".category-item");if(!n)return;const s=n.querySelector("input").value.trim(),l=(u=t==null?void 0:t.category)==null?void 0:u.find(m=>m.name===s),i=(l==null?void 0:l.item)||s.toLowerCase().replace(/\s+/g,"_");T.push({name:s,item:i,element:n}),n.remove()}function le(){const c=document.querySelector(".btn-outline");c&&c.addEventListener("click",e=>{e.preventDefault(),he().then(()=>{const n=te();ne(n==null?void 0:n.userId).then(()=>{location.reload()})})})}function ie(c){var n;const e=c.config||{};for(const o in e)for(const s in e[o]){const l=(n=e[o][s])==null?void 0:n.name;if(!l)continue;const i=document.querySelector(`input[data-type="${o}"][data-slot="${s}"]`);i&&(i.value=l)}}function P(c,e){var s,l,i;const n=(s=c.inventory)==null?void 0:s[e],o=(i=(l=c.spec)==null?void 0:l.consumption)==null?void 0:i[e];n&&Object.keys(n).forEach(u=>{const m=n[u],f=o==null?void 0:o[u];A(e,u,"current",m.current),A(e,u,"max",m.max),(f==null?void 0:f.perSecond)!==void 0&&A(e,u,"perSecond",f.perSecond)})}function A(c,e,n,o){const s=document.querySelector(`input[data-type="${c}"][data-slot="${e}"][data-field="${n}"]`);s&&(s.value=String(o))}function ue(c){var n;const e=(n=c.inventory)==null?void 0:n.cup;e&&Object.keys(e).forEach(o=>{const s=e[o];K(o,"current",s.current),K(o,"max",s.max)})}function K(c,e,n){const o=document.querySelector(`input[data-type="${c}"][data-field="${e}"]`);o&&(o.value=String(n))}function ae(c){var o;const e=((o=c.flags)==null?void 0:o.soldOut)||{};document.querySelectorAll('input[data-field="soldOut"]').forEach(s=>{const l=s.dataset.type,i=s.dataset.slot;if(!l)return;const u=i?`${l}_${i}`:`cup_${l}`;s.checked=!!e[u]})}async function de(c){try{const n=await(await O(`/model_inventory_calculate?func=get-runtime&userId=${c}`)).json();n!=null&&n.ok&&n.inventory&&n.spec?(ie(n),P(n,"coffee"),P(n,"garucha"),P(n,"syrup"),ae(n),ue(n)):console.warn("⚠️ inventory runtime 없음")}catch(e){console.warn("⚠️ inventory 조회 실패",e)}}let t=null;async function me(){try{const e=JSON.parse(localStorage.getItem("userInfo")||"{}").userId;if(!e)return;const o=await(await O(`/model_user_setting?func=get-user&userId=${e}`)).json();if(o&&o.user){if(t=o.user,!["model0000","zero16"].includes(t.userId)){const a=document.querySelector("#inventory");a.style.display="none"}t.inventoryCheckEnabled!==!1&&await de(t.userId);const l=document.getElementById("storeNm");l&&(l.value=o.user.storeName||"");const i=document.querySelector("#tel-input");i&&(i.value=o.user.tel||"");const u=document.getElementById("businessNo");u&&(u.value=o.user.businessNo||"");const m=document.querySelector("#address-input");m&&(m.value=o.user.address||"");const f=document.querySelector('.in-box input[type="text"]');f&&(f.value=o.user.limitCount||"");const g=document.querySelector("#wash-time-input");g&&(g.value=o.user.washTime||"");const v=document.querySelector("#remote-address");v&&(v.value=o.user.remoteAddress||"");const h=document.getElementById("point-check");h&&(h.checked=!o.user.payType);const w=document.getElementById("coupon-check");w&&(w.checked=!o.user.coupon);const I=document.getElementById("vcat-check");I&&(I.checked=o.user.vcat);const k=document.getElementById("inventory-check");if(k&&(k.checked=o.user.inventoryCheckEnabled),fe(o.user.category||[]),o.user.logoUrl){const a=document.getElementById("logoPreview");a&&(a.src=o.user.logoUrl,a.style.display="block",a.onerror=()=>{a.style.display="none"})}else if(o.user.logoBase64){const a=document.getElementById("logoPreview");a&&(a.src=o.user.logoBase64,a.style.display="block")}if(o.user.iconUrl){const a=document.getElementById("iconPreview");a&&(a.src=o.user.iconUrl,a.style.display="block",a.onerror=()=>{a.style.display="none"})}else if(o.user.iconBase64){const a=document.getElementById("iconPreview");a&&(a.src=o.user.iconBase64,a.style.display="block")}}}catch{window.showToast("매장 정보 로드에 실패했습니다.",3e3,"error")}}function fe(c){const e=document.getElementById("category-container");if(!e)return;e.innerHTML="";const n=(c||[]).filter(o=>o&&o.no!=="0"&&o.item!=="all"&&o.item!=="0");n.length>0&&n.forEach((o,s)=>{const l=String(o.item??""),i=String(o.no??String(s+1)),u=document.createElement("div");u.className="data_input category-item",u.innerHTML=`
        <p>카테고리${i}</p>
        <div class="category-input-group">
          <input type="text" />
          <button type="button" class="btn-i delete-category">-</button>
        </div>
      `;const m=u.querySelector("input");m.value=o.name||"",m.dataset.originalItem=l,m.dataset.originalNo=i;const f=u.querySelector(".delete-category");f&&f.addEventListener("click",()=>R(f)),e.appendChild(u)})}function ye(){const c={};return document.querySelectorAll('#inventory input[data-field="current"], #inventory input[data-field="max"]').forEach(e=>{const n=e.dataset.type,o=e.dataset.slot,s=e.dataset.field,l=Number(e.value||0);if(n==="paper"||n==="plastic"){c.cup=c.cup||{},c.cup[n]=c.cup[n]||{},c.cup[n][s]=l;return}c[n]=c[n]||{},c[n][o]=c[n][o]||{},c[n][o][s]=l}),c}function pe(){const c={};return document.querySelectorAll('#inventory input[type="checkbox"][data-field="soldOut"]').forEach(e=>{const n=e.dataset.type,o=e.dataset.slot,s=o?`${n}_${o}`:`cup_${n}`;e.checked?c[s]=!0:c[s]=!1}),c}function ge(){const c={consumption:{}};return document.querySelectorAll('#inventory input[data-field="perSecond"]').forEach(e=>{const n=e.dataset.type,o=e.dataset.slot,s=Number(e.value);Number.isNaN(s)||(c.consumption[n]||(c.consumption[n]={}),c.consumption[n][o]={perSecond:s})}),c}function ve(){const c={};return document.querySelectorAll('#inventory input[data-field="name"]').forEach(e=>{const n=e.dataset.type,o=e.dataset.slot,s=e.value.trim();s&&(c[n]||(c[n]={}),c[n][o]={name:s})}),c}async function he(){var c;try{let e=function(r){return(r||[]).map(d=>({no:String(d.no??""),name:String(d.name??""),item:String(d.item??"")})).sort((d,p)=>Number(d.no)-Number(p.no))};const n=JSON.parse(localStorage.getItem("userInfo")||"{}");if(!oe())return;const s=n.userId||"zero001",l=document.querySelector("#storeNm"),i=document.querySelector("#tel-input"),u=document.querySelector("#address-input"),m=document.getElementById("businessNo"),f=document.querySelector("#remote-address"),g=document.querySelector('input[type="password"]'),v=document.getElementById("limit-count"),h=document.getElementById("wash-time-input"),w=document.getElementById("point-check"),I=document.getElementById("coupon-check"),k=document.getElementById("vcat-check"),a=document.getElementById("inventory-check");let y=!1,j=!1,z=!1,q=!1,V=!1;const Z=document.querySelectorAll("#category-container .category-input-group input"),H=Array.from(Z).map((r,d)=>{const p=r,B=p.value.trim();if(!B)return null;const G=String(d+1),D=G,ee=p.dataset.originalItem||"";return{name:B,no:G,item:D,originalItem:ee}}).filter(Boolean),$=[{name:"전체메뉴",no:"0",item:"all"},...H.map(({name:r,no:d,item:p})=>({name:r,no:d,item:p}))],L={all:"all"};for(const r of H)r.originalItem&&(L[r.originalItem]=r.item);for(const r of T){const d=String((r==null?void 0:r.item)??"");d&&(L[d]="all")}const U=(t==null?void 0:t.category)||[],M=T.length>0;if(q=M||JSON.stringify(e($))!==JSON.stringify(e(U)),l&&l.value!==(t==null?void 0:t.storeName)&&(y=!0),i&&i.value!==(t==null?void 0:t.tel)&&(y=!0),u&&u.value!==(t==null?void 0:t.address)&&(y=!0),m&&m.value!==(t==null?void 0:t.businessNo)&&(y=!0),f&&f.value!==(t==null?void 0:t.remoteAddress)&&(y=!0),h&&h.value!==(t==null?void 0:t.washTime)&&(y=!0),w&&w.checked!==!(t!=null&&t.payType)&&(y=!0),I&&I.checked!==!(t!=null&&t.coupon)&&(y=!0),k&&k.checked!==(t==null?void 0:t.vcat)&&(y=!0),a&&a.checked!==(t==null?void 0:t.inventoryCheckEnabled)&&(y=!0,V=!0),g&&g.value!==""&&g.value!=="******"){if(g.value.length<6){window.showToast("비밀번호는 6자리 이상이어야 합니다.",3e3,"warning");return}j=!0}const N=(v==null?void 0:v.value)||"",J=((c=t==null?void 0:t.limitCount)==null?void 0:c.toString())||"";if(v&&N!==""&&N!==J&&(y=!0),(E||S||C||b)&&(z=!0),y||z||q){M&&await Ie(s);const r={userId:s,adminId:s};l&&l.value!==(t==null?void 0:t.storeName)&&(r.storeName=l.value),i&&i.value!==(t==null?void 0:t.tel)&&(r.tel=i.value),u&&u.value!==(t==null?void 0:t.address)&&(r.address=u.value),m&&m.value!==(t==null?void 0:t.businessNo)&&(r.businessNo=m.value),f&&f.value!==(t==null?void 0:t.remoteAddress)&&(r.remoteAddress=f.value),h&&h.value!==(t==null?void 0:t.washTime)&&(r.washTime=h.value),w&&w.checked!==!(t!=null&&t.payType)&&(r.payType=!w.checked),I&&I.checked!==!(t!=null&&t.coupon)&&(r.coupon=!I.checked),k&&k.checked!==(t==null?void 0:t.vcat)&&(r.vcat=k.checked),a&&a.checked!==(t==null?void 0:t.vcat)&&(r.inventoryCheckEnabled=a.checked),v&&N!==""&&N!==J&&(r.limitCount=parseInt(N)),q&&$.length>0&&(r.category=$,r.categoryItemMap=L),E?(r.logoFileName=E.name,r.logoBase64=_):C&&(r.logoFileName="",r.logoBase64="",r.logoUrl=""),S?(r.iconFileName=S.name,r.iconBase64=x):b&&(r.iconFileName="",r.iconBase64="",r.iconUrl="");const d=await F("/model_user_setting?func=update-user",r),p=await d.json();(p.success||p.status==="success"||d.ok)&&await W("/model_machine_controll",{userId:s,func:"update-user"})}if(j){const r=await ce(),d={adminId:r==null?void 0:r.adminId,newPassword:g.value};await F("/model_admin_user?func=update-password",d)}V&&a.checked&&await W("/model_inventory_calculate?func=init-runtime",{userId:t==null?void 0:t.userId}),await we(n.userId),window.showToast("변경사항이 저장되었습니다.",3e3,"success"),T=[],g&&(g.value="******"),E&&(E=null,_=""),S&&(S=null,x=""),C=!1,b=!1,t&&(C&&(t.logoUrl="",t.logoBase64=""),b&&(t.iconUrl="",t.iconBase64=""),q&&(t.category=$.map((r,d)=>{var p,B;return{...r,item:((B=(p=t==null?void 0:t.category)==null?void 0:p[d])==null?void 0:B.item)||r.name.toLowerCase().replace(/\s+/g,"_")}})))}catch{window.showToast("저장 중 오류가 발생했습니다.",3e3,"error")}}async function we(c){const e=ye(),n=ge(),o=ve(),s=pe();await F("/model_inventory_calculate?func=update-config",{userId:c,inventory:e,spec:n,config:o,soldOut:s})}async function Ie(c){for(const e of T)try{console.log(`카테고리 ${e.name} 처리 시작`),console.log("전송할 데이터:",{userId:c,category:e.item,categoryName:e.name});const n=await O(`/model_user_setting?func=check-category-usage&userId=${c}&category=${e.item}`);if(console.log("응답:",n.status,n.ok),!n.ok)throw new Error(`카테고리 사용 여부 확인 실패: ${n.status}`);const o=await n.json();if(console.log("결과:",o),o.hasAny){console.log(`카테고리 ${e.name} 사용 중`);const s=await fetch("https://api.narrowroad-model.com/model_user_setting?func=move-category-to-all",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({userId:c,category:e.item})});if(console.log("응답:",s.status,s.ok),!s.ok)throw new Error(`카테고리 이동 실패: ${s.status}`);const l=await s.json();if(console.log("결과:",l),!l.success)throw new Error("카테고리 이동에 실패했습니다.")}else console.log(`카테고리 ${e.name} 사용되지 않음 - 바로 삭제`);console.log(`카테고리 ${e.name} 처리 완료`)}catch(n){console.error(`카테고리 ${e.name} 처리 중 오류:`,n);const o=document.getElementById("category-container");o&&(o.appendChild(e.element),o.querySelectorAll(".category-item").forEach((l,i)=>{const u=l.querySelector("p");u&&(u.textContent=`카테고리 ${i+1}`)})),window.showToast(`카테고리 ${e.name} 삭제 중 오류가 발생했습니다.`,3e3,"error")}}function ke(){const c=document.getElementById("logoUpload");c&&c.addEventListener("change",Ee);const e=document.getElementById("iconUpload");e&&e.addEventListener("change",Se);const n=document.querySelector(".icon-header button");n&&n.addEventListener("click",Be);const s=document.querySelectorAll(".icon-header button")[1];s&&s.addEventListener("click",Ce)}function Q(c,e,n){return new Promise(o=>{const s=new Image;s.onload=()=>{o(s.width<=e&&s.height<=n)},s.src=URL.createObjectURL(c)})}function X(c){return new Promise((e,n)=>{const o=new FileReader;o.onload=()=>{const l=o.result.split(",")[1];e(l)},o.onerror=n,o.readAsDataURL(c)})}function Y(c){return new Promise((e,n)=>{const o=new FileReader;o.onload=()=>e(o.result),o.onerror=n,o.readAsDataURL(c)})}async function Ee(c){var l;const e=(l=c.target.files)==null?void 0:l[0];if(!e)return;if(e.size>2*1024*1024){window.showToast("파일 크기는 2MB 이하여야 합니다.",3e3,"warning");return}if(!await Q(e,600,140)){window.showToast("로고 이미지는 600x140 이하여야 합니다.",3e3,"warning");return}E=e,_=await X(e),C=!1;const o=document.getElementById("fileName");o&&(o.textContent=e.name);const s=document.getElementById("logoPreview");if(s){const i=await Y(e);s.src=i,s.style.display="block"}}async function Se(c){var l;const e=(l=c.target.files)==null?void 0:l[0];if(!e)return;if(e.size>2*1024*1024){window.showToast("파일 크기는 2MB 이하여야 합니다.",3e3,"warning");return}if(!await Q(e,1300,2e3)){window.showToast("아이콘 이미지는 1300x2000 이하여야 합니다.",3e3,"warning");return}S=e,x=await X(e),b=!1;const o=document.getElementById("iconFileName");o&&(o.textContent=e.name);const s=document.getElementById("iconPreview");if(s){const i=await Y(e);s.src=i,s.style.display="block"}}function Be(){if(!(t!=null&&t.logoUrl)&&!(t!=null&&t.logoBase64))return;E=null,_="",C=!0;const c=document.getElementById("logoUpload");c&&(c.value="");const e=document.getElementById("fileName");e&&(e.textContent="");const n=document.getElementById("logoPreview");n&&(n.src="",n.style.display="none"),t&&(t.logoUrl="",t.logoBase64="")}function Ce(){if(!(t!=null&&t.iconUrl)&&!(t!=null&&t.iconBase64))return;S=null,x="",b=!0;const c=document.getElementById("iconUpload");c&&(c.value="");const e=document.getElementById("iconFileName");e&&(e.textContent="");const n=document.getElementById("iconPreview");n&&(n.src="",n.style.display="none"),t&&(t.iconUrl="",t.iconBase64="")}export{Ne as initNormalSet};
