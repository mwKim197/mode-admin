import{a as H,d as z,e as K}from"./main-B1NCi6Rz.js";let I=null,B=null,N="",T="",S=!1,b=!1,q=[];function ie(){Z(),Y(),te(),Q()}function Q(){document.querySelectorAll(".delete-category").forEach(n=>{n.addEventListener("click",()=>x(n))});const o=document.querySelector(".category-actions .btn-outline");o&&o.addEventListener("click",X)}function X(){const c=document.getElementById("category-container");if(!c)return;const o=c.querySelectorAll(".category-item").length;if(o>=9){window.showToast("카테고리는 최대 9개까지 추가할 수 있습니다.",3e3,"warning");return}const n=document.createElement("div");n.className="data_input category-item",n.innerHTML=`
    <p>카테고리${o+1}</p>
    <div class="category-input-group">
      <input type="text"/>
      <button type="button" class="btn-i delete-category">-</button>
    </div>
  `;const t=n.querySelector(".delete-category");t&&t.addEventListener("click",()=>x(t)),c.appendChild(n)}function x(c){var a;if(!document.getElementById("category-container"))return;const n=c.closest(".category-item");if(!n)return;const s=n.querySelector("input").value.trim(),i=(a=e==null?void 0:e.category)==null?void 0:a.find(f=>f.name===s),u=(i==null?void 0:i.item)||s.toLowerCase().replace(/\s+/g,"_");q.push({name:s,item:u,element:n}),n.remove()}function Y(){const c=document.querySelector(".btn-outline");c&&c.addEventListener("click",o=>{o.preventDefault(),D()})}let e=null;async function Z(){try{const o=JSON.parse(localStorage.getItem("userInfo")||"{}").userId;if(!o)return;const t=await(await H(`/model_user_setting?func=get-user&userId=${o}`)).json();if(t&&t.user){e=t.user;const s=document.getElementById("storeNm");s&&(s.value=t.user.storeName||"");const i=document.querySelector("#tel-input");i&&(i.value=t.user.tel||"");const u=document.getElementById("businessNo");u&&(u.value=t.user.businessNo||"");const a=document.querySelector("#address-input");a&&(a.value=t.user.address||"");const f=document.querySelector('.in-box input[type="text"]');f&&(f.value=t.user.limitCount||"");const y=document.querySelector("#wash-time-input");y&&(y.value=t.user.washTime||"");const g=document.querySelector("#remote-address");g&&(g.value=t.user.remoteAddress||"");const w=document.getElementById("point-check");w&&(w.checked=!t.user.payType);const h=document.getElementById("vcat-check");if(h&&(h.checked=t.user.vcat),U(t.user.category||[]),t.user.logoUrl){const r=document.getElementById("logoPreview");r&&(r.src=t.user.logoUrl,r.style.display="block",r.onerror=()=>{r.style.display="none"})}else if(t.user.logoBase64){const r=document.getElementById("logoPreview");r&&(r.src=t.user.logoBase64,r.style.display="block")}if(t.user.iconUrl){const r=document.getElementById("iconPreview");r&&(r.src=t.user.iconUrl,r.style.display="block",r.onerror=()=>{r.style.display="none"})}else if(t.user.iconBase64){const r=document.getElementById("iconPreview");r&&(r.src=t.user.iconBase64,r.style.display="block")}}}catch{window.showToast("매장 정보 로드에 실패했습니다.",3e3,"error")}}function U(c){const o=document.getElementById("category-container");if(!o)return;o.innerHTML="";const n=(c||[]).filter(t=>t&&t.no!=="0"&&t.item!=="all"&&t.item!=="0");n.length>0&&n.forEach(t=>{const s=String(t.item??""),i=document.createElement("div");i.className="data_input category-item",i.innerHTML=`
        <p>카테고리${s}</p>
        <div class="category-input-group">
          <input type="text" value="${t.name||""}" />
          <button type="button" class="btn-i delete-category">-</button>
        </div>
      `;const u=i.querySelector(".delete-category");u&&u.addEventListener("click",()=>x(u)),o.appendChild(i)})}async function D(){var c;try{const o=JSON.parse(localStorage.getItem("userInfo")||"{}");if(!localStorage.getItem("accessToken"))return;const t=o.userId||"zero001",s=document.querySelector("#storeNm"),i=document.querySelector("#tel-input"),u=document.querySelector("#address-input"),a=document.getElementById("businessNo"),f=document.querySelector("#remote-address"),y=document.querySelector('input[type="password"]'),g=document.getElementById("limit-count"),w=document.getElementById("wash-time-input"),h=document.getElementById("point-check"),r=document.getElementById("vcat-check");let m=!1,L=!1,P=!1,E=!1;const M=document.querySelectorAll("#category-container .category-input-group input"),J=Array.from(M).map((l,p)=>{var R;const d=l.value.trim();if(!d)return null;const v=(R=e==null?void 0:e.category)==null?void 0:R.find(W=>W.name===d),F=(p+1).toString(),G=(v==null?void 0:v.item)||F;return{name:d,no:F,item:G}}).filter(l=>l!==null),k=[{name:"전체메뉴",no:"0",item:"all"},...J],_=(e==null?void 0:e.category)||[],A=q.length>0;if(k.length!==_.length||A)E=!0;else for(let l=0;l<k.length;l++){const p=k[l],d=_[l];if(!d||(p==null?void 0:p.name)!==d.name){E=!0;break}}if(s&&s.value!==(e==null?void 0:e.storeName)&&(m=!0),i&&i.value!==(e==null?void 0:e.tel)&&(m=!0),u&&u.value!==(e==null?void 0:e.address)&&(m=!0),a&&a.value!==(e==null?void 0:e.businessNo)&&(m=!0),f&&f.value!==(e==null?void 0:e.remoteAddress)&&(m=!0),w&&w.value!==(e==null?void 0:e.washTime)&&(m=!0),h&&h.checked!==!(e!=null&&e.payType)&&(m=!0),r&&r.checked!==(e==null?void 0:e.vcat)&&(m=!0),y&&y.value!==""&&y.value!=="******"){if(y.value.length<6){window.showToast("비밀번호는 6자리 이상이어야 합니다.",3e3,"warning");return}L=!0}const C=(g==null?void 0:g.value)||"",$=((c=e==null?void 0:e.limitCount)==null?void 0:c.toString())||"";if(g&&C!==""&&C!==$&&(m=!0),(I||B||S||b)&&(P=!0),!m&&!L&&!P&&!E){window.showToast("변경사항이 없습니다.",3e3,"warning");return}if(m||P||E){A&&await ee(t);const l={userId:t,adminId:t};s&&s.value!==(e==null?void 0:e.storeName)&&(l.storeName=s.value),i&&i.value!==(e==null?void 0:e.tel)&&(l.tel=i.value),u&&u.value!==(e==null?void 0:e.address)&&(l.address=u.value),a&&a.value!==(e==null?void 0:e.businessNo)&&(l.businessNo=a.value),f&&f.value!==(e==null?void 0:e.remoteAddress)&&(l.remoteAddress=f.value),w&&w.value!==(e==null?void 0:e.washTime)&&(l.washTime=w.value),h&&h.checked!==!(e!=null&&e.payType)&&(l.payType=!h.checked),r&&r.checked!==(e==null?void 0:e.vcat)&&(l.vcat=r.checked),g&&C!==""&&C!==$&&(l.limitCount=parseInt(C)),E&&k.length>0&&(l.category=k),I?(l.logoFileName=I.name,l.logoBase64=N):S&&(l.logoFileName="",l.logoBase64="",l.logoUrl=""),B?(l.iconFileName=B.name,l.iconBase64=T):b&&(l.iconFileName="",l.iconBase64="",l.iconUrl="");const p=await z("/model_user_setting?func=update-user",l),d=await p.json();(d.success||d.status==="success"||p.ok)&&await K("/model_machine_controll",{userId:t,func:"update-user"})}if(L){const l={userId:t,newPassword:y.value,adminId:t};await z("/model_user_setting?func=update-password",l)}window.showToast("변경사항이 저장되었습니다.",3e3,"success"),q=[],y&&(y.value="******"),I&&(I=null,N=""),B&&(B=null,T=""),S=!1,b=!1,e&&(S&&(e.logoUrl="",e.logoBase64=""),b&&(e.iconUrl="",e.iconBase64=""),E&&(e.category=k.map((l,p)=>{var d,v;return{...l,item:((v=(d=e==null?void 0:e.category)==null?void 0:d[p])==null?void 0:v.item)||l.name.toLowerCase().replace(/\s+/g,"_")}})))}catch{window.showToast("저장 중 오류가 발생했습니다.",3e3,"error")}}async function ee(c){for(const o of q)try{console.log(`카테고리 ${o.name} 처리 시작`),console.log("전송할 데이터:",{userId:c,category:o.item,categoryName:o.name});const n=await H(`/model_user_setting?func=check-category-usage&userId=${c}&category=${o.item}`);if(console.log("응답:",n.status,n.ok),!n.ok)throw new Error(`카테고리 사용 여부 확인 실패: ${n.status}`);const t=await n.json();if(console.log("결과:",t),t.hasAny){console.log(`카테고리 ${o.name} 사용 중`);const s=await fetch("https://api.narrowroad-model.com/model_user_setting?func=move-category-to-all",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({userId:c,category:o.item})});if(console.log("응답:",s.status,s.ok),!s.ok)throw new Error(`카테고리 이동 실패: ${s.status}`);const i=await s.json();if(console.log("결과:",i),!i.success)throw new Error("카테고리 이동에 실패했습니다.")}else console.log(`카테고리 ${o.name} 사용되지 않음 - 바로 삭제`);console.log(`카테고리 ${o.name} 처리 완료`)}catch(n){console.error(`카테고리 ${o.name} 처리 중 오류:`,n);const t=document.getElementById("category-container");t&&(t.appendChild(o.element),t.querySelectorAll(".category-item").forEach((i,u)=>{const a=i.querySelector("p");a&&(a.textContent=`카테고리 ${u+1}`)})),window.showToast(`카테고리 ${o.name} 삭제 중 오류가 발생했습니다.`,3e3,"error")}}function te(){const c=document.getElementById("logoUpload");c&&c.addEventListener("change",oe);const o=document.getElementById("iconUpload");o&&o.addEventListener("change",ne);const n=document.querySelector(".icon-header button");n&&n.addEventListener("click",ce);const s=document.querySelectorAll(".icon-header button")[1];s&&s.addEventListener("click",se)}function V(c,o,n){return new Promise(t=>{const s=new Image;s.onload=()=>{t(s.width<=o&&s.height<=n)},s.src=URL.createObjectURL(c)})}function j(c){return new Promise((o,n)=>{const t=new FileReader;t.onload=()=>{const i=t.result.split(",")[1];o(i)},t.onerror=n,t.readAsDataURL(c)})}function O(c){return new Promise((o,n)=>{const t=new FileReader;t.onload=()=>o(t.result),t.onerror=n,t.readAsDataURL(c)})}async function oe(c){var i;const o=(i=c.target.files)==null?void 0:i[0];if(!o)return;if(o.size>2*1024*1024){window.showToast("파일 크기는 2MB 이하여야 합니다.",3e3,"warning");return}if(!await V(o,600,140)){window.showToast("로고 이미지는 600x140 이하여야 합니다.",3e3,"warning");return}I=o,N=await j(o),S=!1;const t=document.getElementById("fileName");t&&(t.textContent=o.name);const s=document.getElementById("logoPreview");if(s){const u=await O(o);s.src=u,s.style.display="block"}}async function ne(c){var i;const o=(i=c.target.files)==null?void 0:i[0];if(!o)return;if(o.size>2*1024*1024){window.showToast("파일 크기는 2MB 이하여야 합니다.",3e3,"warning");return}if(!await V(o,1300,2e3)){window.showToast("아이콘 이미지는 1300x2000 이하여야 합니다.",3e3,"warning");return}B=o,T=await j(o),b=!1;const t=document.getElementById("iconFileName");t&&(t.textContent=o.name);const s=document.getElementById("iconPreview");if(s){const u=await O(o);s.src=u,s.style.display="block"}}function ce(){if(!(e!=null&&e.logoUrl)&&!(e!=null&&e.logoBase64))return;I=null,N="",S=!0;const c=document.getElementById("logoUpload");c&&(c.value="");const o=document.getElementById("fileName");o&&(o.textContent="");const n=document.getElementById("logoPreview");n&&(n.src="",n.style.display="none"),e&&(e.logoUrl="",e.logoBase64="")}function se(){if(!(e!=null&&e.iconUrl)&&!(e!=null&&e.iconBase64))return;B=null,T="",b=!0;const c=document.getElementById("iconUpload");c&&(c.value="");const o=document.getElementById("iconFileName");o&&(o.textContent="");const n=document.getElementById("iconPreview");n&&(n.src="",n.style.display="none"),e&&(e.iconUrl="",e.iconBase64="")}export{ie as initNormalSet};
