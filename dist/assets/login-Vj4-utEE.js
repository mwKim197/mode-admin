import{s as w}from"./main-BTQuD9qN.js";const u="https://api.narrowroad-model.com";function _(){console.log("✅ login.ts 로드됨"),localStorage.removeItem("accessToken"),localStorage.removeItem("userInfo");const t=document.getElementById("login-form");if(!t){console.error("❌ 로그인 폼을 찾을 수 없음");return}t.addEventListener("submit",async o=>{o.preventDefault(),localStorage.removeItem("accessToken"),localStorage.removeItem("userInfo"),console.log("🗑️ 기존 로그인 토큰 삭제됨");const n=document.getElementById("adminId").value.trim(),e=document.getElementById("password").value.trim(),a=document.getElementById("agree").checked;if(!n||!e){alert("아이디와 비밀번호를 입력해주세요.");return}window.showLoading();try{const r=await fetch(`${u}/model_admin_login?func=login`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({adminId:n,password:e})}),l=await r.json();r.ok?await k(l,a):alert(l.message||"로그인 실패. 다시 시도하세요.")}catch(r){console.error("❌ 로그인 요청 중 오류 발생:",r),alert("서버 오류가 발생했습니다. 다시 시도하세요.")}finally{window.hideLoading()}});const s=document.getElementById("kakao-login-btn");s&&s.addEventListener("click",I)}function I(){const t="240886095629b93f9655026145a39487",s="https://zeroadmin.kr/html/kakao-callback.html",o=new Uint8Array(16);crypto.getRandomValues(o);const n=Array.from(o).map(d=>d.toString(16).padStart(2,"0")).join("");sessionStorage.setItem("kakao_state",n);const e=`https://kauth.kakao.com/oauth/authorize?response_type=code&client_id=${encodeURIComponent(t)}&redirect_uri=${encodeURIComponent(s)}&state=${encodeURIComponent(n)}`,a=window.matchMedia("(max-width: 768px)").matches,r=document.getElementById("agree"),l=!!(r!=null&&r.checked),p=async d=>{if(d.origin!==window.location.origin)return;const m=d.data||{};if(m.type!=="kakao-auth")return;const g=sessionStorage.getItem("kakao_state");if(!g||m.state!==g){console.warn("Invalid state",{got:m.state,expected:g}),alert("로그인 보안 검증에 실패했습니다. 다시 시도해주세요.");return}const{code:h,error:f}=m;if(f||!h){console.error("❌ Kakao OAuth error or code missing:",f),alert("카카오 로그인 실패. 다시 시도하세요.");return}try{const c=await fetch(`${u}/model_admin_login?func=kakao-login`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({code:h,state:g})}),i=await c.json();c.ok&&i.accessToken?await k(i,l):c.ok&&i.redirectUrl?window.location.href=i.redirectUrl:(console.error("❌ 카카오 로그인 실패 응답:",i),alert("카카오 로그인 실패. 다시 시도하세요."))}catch(c){console.error("❌ 카카오 로그인 요청 오류:",c),alert("서버 오류가 발생했습니다. 다시 시도하세요.")}};if(a){window.location.href=e;return}window.addEventListener("message",p,{once:!0}),window.open(e,"kakaoLogin","width=500,height=700")||(window.location.href=e)}async function k(t,s=!1){try{localStorage.setItem("accessToken",t.accessToken),s?(console.log("✅ 로그인 성공 → 자동로그인 활성화"),localStorage.setItem("refreshToken",t.refreshToken)):(console.log("✅ 로그인 성공 → 자동로그인 삭제"),localStorage.removeItem("refreshToken")),console.log("✅ 로그인 성공 → 토큰 저장 완료!");const o=await fetch(`${u}/model_admin_login?func=me`,{method:"GET",headers:{"Content-Type":"application/json",Authorization:`Bearer ${t.accessToken}`},mode:"cors"});if(!o.ok){console.error("❌ 사용자 정보 불러오기 실패:",o.status),alert("유저 정보를 불러오지 못했습니다.");return}const n=await o.json();if(n.userId){const e=await fetch(`${u}/model_user_setting?func=get-user&userId=${n.userId}`,{method:"GET",headers:{"Content-Type":"application/json",Authorization:`Bearer ${t.accessToken}`},mode:"cors"});if(e.ok){const{user:a}=await e.json();w(a),console.log("✅ 사용자 정보 저장 완료")}else{const a=await e.text();console.error("❌ 사용자 정보 조회 실패:",e.status,a),alert("사용자 정보를 불러오지 못했습니다.");return}}window.location.href="/html/home.html"}catch(o){console.error("❌ postLogin 처리 오류:",o),alert("로그인 후 처리 중 오류가 발생했습니다.")}}export{_ as initLogin};
