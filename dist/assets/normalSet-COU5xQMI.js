import{a as A,g as ee,j as te,k as ne,d as P,e as G,c as oe}from"./main-KXpgWIBB.js";let E=null,B=null,q="",$="",b=!1,C=!1,_=[];function Ce(){de(),le(),Ie(),ce()}function ce(){document.querySelectorAll(".delete-category").forEach(o=>{o.addEventListener("click",()=>F(o))});const t=document.querySelector(".category-actions .btn-outline");t&&t.addEventListener("click",se)}function se(){const c=document.getElementById("category-container");if(!c)return;const t=c.querySelectorAll(".category-item").length;if(t>=9){window.showToast("카테고리는 최대 9개까지 추가할 수 있습니다.",3e3,"warning");return}const o=document.createElement("div");o.className="data_input category-item",o.innerHTML=`
    <p>카테고리${t+1}</p>
    <div class="category-input-group">
      <input type="text"/>
      <button type="button" class="btn-i delete-category">-</button>
    </div>
  `;const n=o.querySelector(".delete-category");n&&n.addEventListener("click",()=>F(n)),c.appendChild(o)}function F(c){var a;if(!document.getElementById("category-container"))return;const o=c.closest(".category-item");if(!o)return;const s=o.querySelector("input").value.trim(),l=(a=e==null?void 0:e.category)==null?void 0:a.find(m=>m.name===s),i=(l==null?void 0:l.item)||s.toLowerCase().replace(/\s+/g,"_");_.push({name:s,item:i,element:o}),o.remove()}function le(){const c=document.querySelector(".btn-outline");c&&c.addEventListener("click",t=>{t.preventDefault(),ge().then(()=>{const o=ee();te(o==null?void 0:o.userId).then(()=>{location.reload()})})})}function re(c){var o;const t=c.config||{};for(const n in t)for(const s in t[n]){const l=(o=t[n][s])==null?void 0:o.name;if(!l)continue;const i=document.querySelector(`input[data-type="${n}"][data-slot="${s}"]`);i&&(i.value=l)}}function x(c,t){var s,l,i;const o=(s=c.inventory)==null?void 0:s[t],n=(i=(l=c.spec)==null?void 0:l.consumption)==null?void 0:i[t];o&&Object.keys(o).forEach(a=>{const m=o[a],d=n==null?void 0:n[a];L(t,a,"current",m.current),L(t,a,"max",m.max),(d==null?void 0:d.perSecond)!==void 0&&L(t,a,"perSecond",d.perSecond)})}function L(c,t,o,n){const s=document.querySelector(`input[data-type="${c}"][data-slot="${t}"][data-field="${o}"]`);s&&(s.value=String(n))}function ue(c){var o;const t=(o=c.inventory)==null?void 0:o.cup;t&&Object.keys(t).forEach(n=>{const s=t[n];W(n,"current",s.current),W(n,"max",s.max)})}function W(c,t,o){const n=document.querySelector(`input[data-type="${c}"][data-field="${t}"]`);n&&(n.value=String(o))}function ie(c){var n;const t=((n=c.flags)==null?void 0:n.soldOut)||{};document.querySelectorAll('input[data-field="soldOut"]').forEach(s=>{const l=s.dataset.type,i=s.dataset.slot;if(!l)return;const a=i?`${l}_${i}`:`cup_${l}`;s.checked=!!t[a]})}async function ae(c){try{const o=await(await A(`/model_inventory_calculate?func=get-runtime&userId=${c}`)).json();o!=null&&o.ok&&o.inventory&&o.spec?(re(o),x(o,"coffee"),x(o,"garucha"),x(o,"syrup"),ie(o),ue(o)):console.warn("⚠️ inventory runtime 없음")}catch(t){console.warn("⚠️ inventory 조회 실패",t)}}let e=null;async function de(){try{const t=JSON.parse(localStorage.getItem("userInfo")||"{}").userId;if(!t)return;const n=await(await A(`/model_user_setting?func=get-user&userId=${t}`)).json();if(n&&n.user){if(e=n.user,!["model0000","zero16"].includes(e.userId)){const u=document.querySelector("#inventory");u.style.display="none"}e.inventoryCheckEnabled!==!1&&await ae(e.userId);const l=document.getElementById("storeNm");l&&(l.value=n.user.storeName||"");const i=document.querySelector("#tel-input");i&&(i.value=n.user.tel||"");const a=document.getElementById("businessNo");a&&(a.value=n.user.businessNo||"");const m=document.querySelector("#address-input");m&&(m.value=n.user.address||"");const d=document.querySelector('.in-box input[type="text"]');d&&(d.value=n.user.limitCount||"");const v=document.querySelector("#wash-time-input");v&&(v.value=n.user.washTime||"");const g=document.querySelector("#remote-address");g&&(g.value=n.user.remoteAddress||"");const h=document.getElementById("point-check");h&&(h.checked=!n.user.payType);const w=document.getElementById("coupon-check");w&&(w.checked=!n.user.coupon);const I=document.getElementById("vcat-check");I&&(I.checked=n.user.vcat);const p=document.getElementById("inventory-check");if(p&&(p.checked=n.user.inventoryCheckEnabled),me(n.user.category||[]),n.user.logoUrl){const u=document.getElementById("logoPreview");u&&(u.src=n.user.logoUrl,u.style.display="block",u.onerror=()=>{u.style.display="none"})}else if(n.user.logoBase64){const u=document.getElementById("logoPreview");u&&(u.src=n.user.logoBase64,u.style.display="block")}if(n.user.iconUrl){const u=document.getElementById("iconPreview");u&&(u.src=n.user.iconUrl,u.style.display="block",u.onerror=()=>{u.style.display="none"})}else if(n.user.iconBase64){const u=document.getElementById("iconPreview");u&&(u.src=n.user.iconBase64,u.style.display="block")}}}catch{window.showToast("매장 정보 로드에 실패했습니다.",3e3,"error")}}function me(c){const t=document.getElementById("category-container");if(!t)return;t.innerHTML="";const o=(c||[]).filter(n=>n&&n.no!=="0"&&n.item!=="all"&&n.item!=="0");o.length>0&&o.forEach(n=>{const s=String(n.item??""),l=document.createElement("div");l.className="data_input category-item",l.innerHTML=`
        <p>카테고리${s}</p>
        <div class="category-input-group">
          <input type="text" value="${n.name||""}" />
          <button type="button" class="btn-i delete-category">-</button>
        </div>
      `;const i=l.querySelector(".delete-category");i&&i.addEventListener("click",()=>F(i)),t.appendChild(l)})}function fe(){const c={};return document.querySelectorAll('#inventory input[data-field="current"], #inventory input[data-field="max"]').forEach(t=>{const o=t.dataset.type,n=t.dataset.slot,s=t.dataset.field,l=Number(t.value||0);if(o==="paper"||o==="plastic"){c.cup=c.cup||{},c.cup[o]=c.cup[o]||{},c.cup[o][s]=l;return}c[o]=c[o]||{},c[o][n]=c[o][n]||{},c[o][n][s]=l}),c}function ye(){const c={};return document.querySelectorAll('#inventory input[type="checkbox"][data-field="soldOut"]').forEach(t=>{const o=t.dataset.type,n=t.dataset.slot,s=n?`${o}_${n}`:`cup_${o}`;t.checked?c[s]=!0:c[s]=!1}),c}function pe(){const c={consumption:{}};return document.querySelectorAll('#inventory input[data-field="perSecond"]').forEach(t=>{const o=t.dataset.type,n=t.dataset.slot,s=Number(t.value);Number.isNaN(s)||(c.consumption[o]||(c.consumption[o]={}),c.consumption[o][n]={perSecond:s})}),c}function ve(){const c={};return document.querySelectorAll('#inventory input[data-field="name"]').forEach(t=>{const o=t.dataset.type,n=t.dataset.slot,s=t.value.trim();s&&(c[o]||(c[o]={}),c[o][n]={name:s})}),c}async function ge(){var c;try{const t=JSON.parse(localStorage.getItem("userInfo")||"{}");if(!ne())return;const n=t.userId||"zero001",s=document.querySelector("#storeNm"),l=document.querySelector("#tel-input"),i=document.querySelector("#address-input"),a=document.getElementById("businessNo"),m=document.querySelector("#remote-address"),d=document.querySelector('input[type="password"]'),v=document.getElementById("limit-count"),g=document.getElementById("wash-time-input"),h=document.getElementById("point-check"),w=document.getElementById("coupon-check"),I=document.getElementById("vcat-check"),p=document.getElementById("inventory-check");let u=!1,O=!1,R=!1,N=!1,j=!1;const Y=document.querySelectorAll("#category-container .category-input-group input"),Z=Array.from(Y).map((r,f)=>{var J;const y=r.value.trim();if(!y)return null;const k=(J=e==null?void 0:e.category)==null?void 0:J.find(D=>D.name===y),M=(f+1).toString(),U=(k==null?void 0:k.item)||M;return{name:y,no:M,item:U}}).filter(r=>r!==null),S=[{name:"전체메뉴",no:"0",item:"all"},...Z],z=(e==null?void 0:e.category)||[],V=_.length>0;if(S.length!==z.length||V)N=!0;else for(let r=0;r<S.length;r++){const f=S[r],y=z[r];if(!y||(f==null?void 0:f.name)!==y.name){N=!0;break}}if(s&&s.value!==(e==null?void 0:e.storeName)&&(u=!0),l&&l.value!==(e==null?void 0:e.tel)&&(u=!0),i&&i.value!==(e==null?void 0:e.address)&&(u=!0),a&&a.value!==(e==null?void 0:e.businessNo)&&(u=!0),m&&m.value!==(e==null?void 0:e.remoteAddress)&&(u=!0),g&&g.value!==(e==null?void 0:e.washTime)&&(u=!0),h&&h.checked!==!(e!=null&&e.payType)&&(u=!0),w&&w.checked!==!(e!=null&&e.coupon)&&(u=!0),I&&I.checked!==(e==null?void 0:e.vcat)&&(u=!0),p&&p.checked!==(e==null?void 0:e.inventoryCheckEnabled)&&(u=!0,j=!0),d&&d.value!==""&&d.value!=="******"){if(d.value.length<6){window.showToast("비밀번호는 6자리 이상이어야 합니다.",3e3,"warning");return}O=!0}const T=(v==null?void 0:v.value)||"",H=((c=e==null?void 0:e.limitCount)==null?void 0:c.toString())||"";if(v&&T!==""&&T!==H&&(u=!0),(E||B||b||C)&&(R=!0),u||R||N){V&&await we(n);const r={userId:n,adminId:n};s&&s.value!==(e==null?void 0:e.storeName)&&(r.storeName=s.value),l&&l.value!==(e==null?void 0:e.tel)&&(r.tel=l.value),i&&i.value!==(e==null?void 0:e.address)&&(r.address=i.value),a&&a.value!==(e==null?void 0:e.businessNo)&&(r.businessNo=a.value),m&&m.value!==(e==null?void 0:e.remoteAddress)&&(r.remoteAddress=m.value),g&&g.value!==(e==null?void 0:e.washTime)&&(r.washTime=g.value),h&&h.checked!==!(e!=null&&e.payType)&&(r.payType=!h.checked),w&&w.checked!==!(e!=null&&e.coupon)&&(r.coupon=!w.checked),I&&I.checked!==(e==null?void 0:e.vcat)&&(r.vcat=I.checked),p&&p.checked!==(e==null?void 0:e.vcat)&&(r.inventoryCheckEnabled=p.checked),v&&T!==""&&T!==H&&(r.limitCount=parseInt(T)),N&&S.length>0&&(r.category=S),E?(r.logoFileName=E.name,r.logoBase64=q):b&&(r.logoFileName="",r.logoBase64="",r.logoUrl=""),B?(r.iconFileName=B.name,r.iconBase64=$):C&&(r.iconFileName="",r.iconBase64="",r.iconUrl="");const f=await P("/model_user_setting?func=update-user",r),y=await f.json();(y.success||y.status==="success"||f.ok)&&await G("/model_machine_controll",{userId:n,func:"update-user"})}if(O){const r=await oe(),f={adminId:r==null?void 0:r.adminId,newPassword:d.value};await P("/model_admin_user?func=update-password",f)}j&&p.checked&&await G("/model_inventory_calculate?func=init-runtime",{userId:e==null?void 0:e.userId}),await he(t.userId),window.showToast("변경사항이 저장되었습니다.",3e3,"success"),_=[],d&&(d.value="******"),E&&(E=null,q=""),B&&(B=null,$=""),b=!1,C=!1,e&&(b&&(e.logoUrl="",e.logoBase64=""),C&&(e.iconUrl="",e.iconBase64=""),N&&(e.category=S.map((r,f)=>{var y,k;return{...r,item:((k=(y=e==null?void 0:e.category)==null?void 0:y[f])==null?void 0:k.item)||r.name.toLowerCase().replace(/\s+/g,"_")}})))}catch{window.showToast("저장 중 오류가 발생했습니다.",3e3,"error")}}async function he(c){const t=fe(),o=pe(),n=ve(),s=ye();await P("/model_inventory_calculate?func=update-config",{userId:c,inventory:t,spec:o,config:n,soldOut:s})}async function we(c){for(const t of _)try{console.log(`카테고리 ${t.name} 처리 시작`),console.log("전송할 데이터:",{userId:c,category:t.item,categoryName:t.name});const o=await A(`/model_user_setting?func=check-category-usage&userId=${c}&category=${t.item}`);if(console.log("응답:",o.status,o.ok),!o.ok)throw new Error(`카테고리 사용 여부 확인 실패: ${o.status}`);const n=await o.json();if(console.log("결과:",n),n.hasAny){console.log(`카테고리 ${t.name} 사용 중`);const s=await fetch("https://api.narrowroad-model.com/model_user_setting?func=move-category-to-all",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({userId:c,category:t.item})});if(console.log("응답:",s.status,s.ok),!s.ok)throw new Error(`카테고리 이동 실패: ${s.status}`);const l=await s.json();if(console.log("결과:",l),!l.success)throw new Error("카테고리 이동에 실패했습니다.")}else console.log(`카테고리 ${t.name} 사용되지 않음 - 바로 삭제`);console.log(`카테고리 ${t.name} 처리 완료`)}catch(o){console.error(`카테고리 ${t.name} 처리 중 오류:`,o);const n=document.getElementById("category-container");n&&(n.appendChild(t.element),n.querySelectorAll(".category-item").forEach((l,i)=>{const a=l.querySelector("p");a&&(a.textContent=`카테고리 ${i+1}`)})),window.showToast(`카테고리 ${t.name} 삭제 중 오류가 발생했습니다.`,3e3,"error")}}function Ie(){const c=document.getElementById("logoUpload");c&&c.addEventListener("change",ke);const t=document.getElementById("iconUpload");t&&t.addEventListener("change",Ee);const o=document.querySelector(".icon-header button");o&&o.addEventListener("click",Be);const s=document.querySelectorAll(".icon-header button")[1];s&&s.addEventListener("click",Se)}function K(c,t,o){return new Promise(n=>{const s=new Image;s.onload=()=>{n(s.width<=t&&s.height<=o)},s.src=URL.createObjectURL(c)})}function Q(c){return new Promise((t,o)=>{const n=new FileReader;n.onload=()=>{const l=n.result.split(",")[1];t(l)},n.onerror=o,n.readAsDataURL(c)})}function X(c){return new Promise((t,o)=>{const n=new FileReader;n.onload=()=>t(n.result),n.onerror=o,n.readAsDataURL(c)})}async function ke(c){var l;const t=(l=c.target.files)==null?void 0:l[0];if(!t)return;if(t.size>2*1024*1024){window.showToast("파일 크기는 2MB 이하여야 합니다.",3e3,"warning");return}if(!await K(t,600,140)){window.showToast("로고 이미지는 600x140 이하여야 합니다.",3e3,"warning");return}E=t,q=await Q(t),b=!1;const n=document.getElementById("fileName");n&&(n.textContent=t.name);const s=document.getElementById("logoPreview");if(s){const i=await X(t);s.src=i,s.style.display="block"}}async function Ee(c){var l;const t=(l=c.target.files)==null?void 0:l[0];if(!t)return;if(t.size>2*1024*1024){window.showToast("파일 크기는 2MB 이하여야 합니다.",3e3,"warning");return}if(!await K(t,1300,2e3)){window.showToast("아이콘 이미지는 1300x2000 이하여야 합니다.",3e3,"warning");return}B=t,$=await Q(t),C=!1;const n=document.getElementById("iconFileName");n&&(n.textContent=t.name);const s=document.getElementById("iconPreview");if(s){const i=await X(t);s.src=i,s.style.display="block"}}function Be(){if(!(e!=null&&e.logoUrl)&&!(e!=null&&e.logoBase64))return;E=null,q="",b=!0;const c=document.getElementById("logoUpload");c&&(c.value="");const t=document.getElementById("fileName");t&&(t.textContent="");const o=document.getElementById("logoPreview");o&&(o.src="",o.style.display="none"),e&&(e.logoUrl="",e.logoBase64="")}function Se(){if(!(e!=null&&e.iconUrl)&&!(e!=null&&e.iconBase64))return;B=null,$="",C=!0;const c=document.getElementById("iconUpload");c&&(c.value="");const t=document.getElementById("iconFileName");t&&(t.textContent="");const o=document.getElementById("iconPreview");o&&(o.src="",o.style.display="none"),e&&(e.iconUrl="",e.iconBase64="")}export{Ce as initNormalSet};
