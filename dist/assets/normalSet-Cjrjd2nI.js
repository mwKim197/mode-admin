import{a as F,g as D,j as ee,k as te,d as J,e as G,c as ne}from"./main-Bhqf6MiU.js";let k=null,E=null,q="",x="",C=!1,N=!1,L=[];function ve(){re(),se(),me(),oe()}function oe(){document.querySelectorAll(".delete-category").forEach(o=>{o.addEventListener("click",()=>R(o))});const n=document.querySelector(".category-actions .btn-outline");n&&n.addEventListener("click",ce)}function ce(){const c=document.getElementById("category-container");if(!c)return;const n=c.querySelectorAll(".category-item").length;if(n>=9){window.showToast("카테고리는 최대 9개까지 추가할 수 있습니다.",3e3,"warning");return}const o=document.createElement("div");o.className="data_input category-item",o.innerHTML=`
    <p>카테고리${n+1}</p>
    <div class="category-input-group">
      <input type="text"/>
      <button type="button" class="btn-i delete-category">-</button>
    </div>
  `;const t=o.querySelector(".delete-category");t&&t.addEventListener("click",()=>R(t)),c.appendChild(o)}function R(c){var a;if(!document.getElementById("category-container"))return;const o=c.closest(".category-item");if(!o)return;const s=o.querySelector("input").value.trim(),i=(a=e==null?void 0:e.category)==null?void 0:a.find(m=>m.name===s),u=(i==null?void 0:i.item)||s.toLowerCase().replace(/\s+/g,"_");L.push({name:s,item:u,element:o}),o.remove()}function se(){const c=document.querySelector(".btn-outline");c&&c.addEventListener("click",n=>{n.preventDefault(),ae().then(()=>{const o=D();ee(o==null?void 0:o.userId).then(()=>{location.reload()})})})}function le(c){var o;const n=c.config||{};for(const t in n)for(const s in n[t]){const i=(o=n[t][s])==null?void 0:o.name;if(!i)continue;const u=document.querySelector(`input[data-type="${t}"][data-slot="${s}"]`);u&&(u.value=i)}}function _(c,n){var s,i,u;const o=(s=c.inventory)==null?void 0:s[n],t=(u=(i=c.spec)==null?void 0:i.consumption)==null?void 0:u[n];o&&Object.keys(o).forEach(a=>{const m=o[a],d=t==null?void 0:t[a];A(n,a,"current",m.current),A(n,a,"max",m.max),(d==null?void 0:d.perSecond)!==void 0&&A(n,a,"perSecond",d.perSecond)})}function A(c,n,o,t){const s=document.querySelector(`input[data-type="${c}"][data-slot="${n}"][data-field="${o}"]`);s&&(s.value=String(t))}async function ie(c){try{const o=await(await F(`/model_inventory_calculate?func=get-runtime&userId=${c}`)).json();o!=null&&o.ok&&o.inventory&&o.spec?(le(o),_(o,"coffee"),_(o,"garucha"),_(o,"syrup")):console.warn("⚠️ inventory runtime 없음")}catch(n){console.warn("⚠️ inventory 조회 실패",n)}}let e=null;async function re(){try{const n=JSON.parse(localStorage.getItem("userInfo")||"{}").userId;if(!n)return;const t=await(await F(`/model_user_setting?func=get-user&userId=${n}`)).json();if(t&&t.user){if(e=t.user,!["model0000","zero16"].includes(e.userId)){const r=document.querySelector("#inventory");r.style.display="none"}e.inventoryCheckEnabled!==!1&&await ie(e.userId);const i=document.getElementById("storeNm");i&&(i.value=t.user.storeName||"");const u=document.querySelector("#tel-input");u&&(u.value=t.user.tel||"");const a=document.getElementById("businessNo");a&&(a.value=t.user.businessNo||"");const m=document.querySelector("#address-input");m&&(m.value=t.user.address||"");const d=document.querySelector('.in-box input[type="text"]');d&&(d.value=t.user.limitCount||"");const g=document.querySelector("#wash-time-input");g&&(g.value=t.user.washTime||"");const h=document.querySelector("#remote-address");h&&(h.value=t.user.remoteAddress||"");const v=document.getElementById("point-check");v&&(v.checked=!t.user.payType);const w=document.getElementById("coupon-check");w&&(w.checked=!t.user.coupon);const I=document.getElementById("vcat-check");I&&(I.checked=t.user.vcat);const p=document.getElementById("inventory-check");if(p&&(p.checked=t.user.inventoryCheckEnabled),ue(t.user.category||[]),t.user.logoUrl){const r=document.getElementById("logoPreview");r&&(r.src=t.user.logoUrl,r.style.display="block",r.onerror=()=>{r.style.display="none"})}else if(t.user.logoBase64){const r=document.getElementById("logoPreview");r&&(r.src=t.user.logoBase64,r.style.display="block")}if(t.user.iconUrl){const r=document.getElementById("iconPreview");r&&(r.src=t.user.iconUrl,r.style.display="block",r.onerror=()=>{r.style.display="none"})}else if(t.user.iconBase64){const r=document.getElementById("iconPreview");r&&(r.src=t.user.iconBase64,r.style.display="block")}}}catch{window.showToast("매장 정보 로드에 실패했습니다.",3e3,"error")}}function ue(c){const n=document.getElementById("category-container");if(!n)return;n.innerHTML="";const o=(c||[]).filter(t=>t&&t.no!=="0"&&t.item!=="all"&&t.item!=="0");o.length>0&&o.forEach(t=>{const s=String(t.item??""),i=document.createElement("div");i.className="data_input category-item",i.innerHTML=`
        <p>카테고리${s}</p>
        <div class="category-input-group">
          <input type="text" value="${t.name||""}" />
          <button type="button" class="btn-i delete-category">-</button>
        </div>
      `;const u=i.querySelector(".delete-category");u&&u.addEventListener("click",()=>R(u)),n.appendChild(i)})}async function ae(){var c;try{const n=JSON.parse(localStorage.getItem("userInfo")||"{}");if(!te())return;const t=n.userId||"zero001",s=document.querySelector("#storeNm"),i=document.querySelector("#tel-input"),u=document.querySelector("#address-input"),a=document.getElementById("businessNo"),m=document.querySelector("#remote-address"),d=document.querySelector('input[type="password"]'),g=document.getElementById("limit-count"),h=document.getElementById("wash-time-input"),v=document.getElementById("point-check"),w=document.getElementById("coupon-check"),I=document.getElementById("vcat-check"),p=document.getElementById("inventory-check");let r=!1,P=!1,$=!1,S=!1,j=!1;const X=document.querySelectorAll("#category-container .category-input-group input"),Y=Array.from(X).map((l,f)=>{var M;const y=l.value.trim();if(!y)return null;const B=(M=e==null?void 0:e.category)==null?void 0:M.find(U=>U.name===y),O=(f+1).toString(),Z=(B==null?void 0:B.item)||O;return{name:y,no:O,item:Z}}).filter(l=>l!==null),b=[{name:"전체메뉴",no:"0",item:"all"},...Y],z=(e==null?void 0:e.category)||[],V=L.length>0;if(b.length!==z.length||V)S=!0;else for(let l=0;l<b.length;l++){const f=b[l],y=z[l];if(!y||(f==null?void 0:f.name)!==y.name){S=!0;break}}if(s&&s.value!==(e==null?void 0:e.storeName)&&(r=!0),i&&i.value!==(e==null?void 0:e.tel)&&(r=!0),u&&u.value!==(e==null?void 0:e.address)&&(r=!0),a&&a.value!==(e==null?void 0:e.businessNo)&&(r=!0),m&&m.value!==(e==null?void 0:e.remoteAddress)&&(r=!0),h&&h.value!==(e==null?void 0:e.washTime)&&(r=!0),v&&v.checked!==!(e!=null&&e.payType)&&(r=!0),w&&w.checked!==!(e!=null&&e.coupon)&&(r=!0),I&&I.checked!==(e==null?void 0:e.vcat)&&(r=!0),p&&p.checked!==(e==null?void 0:e.inventoryCheckEnabled)&&(r=!0,j=!0),d&&d.value!==""&&d.value!=="******"){if(d.value.length<6){window.showToast("비밀번호는 6자리 이상이어야 합니다.",3e3,"warning");return}P=!0}const T=(g==null?void 0:g.value)||"",H=((c=e==null?void 0:e.limitCount)==null?void 0:c.toString())||"";if(g&&T!==""&&T!==H&&(r=!0),(k||E||C||N)&&($=!0),!r&&!P&&!$&&!S){window.showToast("변경사항이 없습니다.",3e3,"warning");return}if(r||$||S){V&&await de(t);const l={userId:t,adminId:t};s&&s.value!==(e==null?void 0:e.storeName)&&(l.storeName=s.value),i&&i.value!==(e==null?void 0:e.tel)&&(l.tel=i.value),u&&u.value!==(e==null?void 0:e.address)&&(l.address=u.value),a&&a.value!==(e==null?void 0:e.businessNo)&&(l.businessNo=a.value),m&&m.value!==(e==null?void 0:e.remoteAddress)&&(l.remoteAddress=m.value),h&&h.value!==(e==null?void 0:e.washTime)&&(l.washTime=h.value),v&&v.checked!==!(e!=null&&e.payType)&&(l.payType=!v.checked),w&&w.checked!==!(e!=null&&e.coupon)&&(l.coupon=!w.checked),I&&I.checked!==(e==null?void 0:e.vcat)&&(l.vcat=I.checked),p&&p.checked!==(e==null?void 0:e.vcat)&&(l.inventoryCheckEnabled=p.checked),g&&T!==""&&T!==H&&(l.limitCount=parseInt(T)),S&&b.length>0&&(l.category=b),k?(l.logoFileName=k.name,l.logoBase64=q):C&&(l.logoFileName="",l.logoBase64="",l.logoUrl=""),E?(l.iconFileName=E.name,l.iconBase64=x):N&&(l.iconFileName="",l.iconBase64="",l.iconUrl="");const f=await J("/model_user_setting?func=update-user",l),y=await f.json();(y.success||y.status==="success"||f.ok)&&await G("/model_machine_controll",{userId:t,func:"update-user"})}if(P){const l=await ne(),f={adminId:l==null?void 0:l.adminId,newPassword:d.value};await J("/model_admin_user?func=update-password",f)}j&&p.checked&&await G("/model_inventory_calculate?func=init-runtime",{userId:e==null?void 0:e.userId}),window.showToast("변경사항이 저장되었습니다.",3e3,"success"),L=[],d&&(d.value="******"),k&&(k=null,q=""),E&&(E=null,x=""),C=!1,N=!1,e&&(C&&(e.logoUrl="",e.logoBase64=""),N&&(e.iconUrl="",e.iconBase64=""),S&&(e.category=b.map((l,f)=>{var y,B;return{...l,item:((B=(y=e==null?void 0:e.category)==null?void 0:y[f])==null?void 0:B.item)||l.name.toLowerCase().replace(/\s+/g,"_")}})))}catch{window.showToast("저장 중 오류가 발생했습니다.",3e3,"error")}}async function de(c){for(const n of L)try{console.log(`카테고리 ${n.name} 처리 시작`),console.log("전송할 데이터:",{userId:c,category:n.item,categoryName:n.name});const o=await F(`/model_user_setting?func=check-category-usage&userId=${c}&category=${n.item}`);if(console.log("응답:",o.status,o.ok),!o.ok)throw new Error(`카테고리 사용 여부 확인 실패: ${o.status}`);const t=await o.json();if(console.log("결과:",t),t.hasAny){console.log(`카테고리 ${n.name} 사용 중`);const s=await fetch("https://api.narrowroad-model.com/model_user_setting?func=move-category-to-all",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({userId:c,category:n.item})});if(console.log("응답:",s.status,s.ok),!s.ok)throw new Error(`카테고리 이동 실패: ${s.status}`);const i=await s.json();if(console.log("결과:",i),!i.success)throw new Error("카테고리 이동에 실패했습니다.")}else console.log(`카테고리 ${n.name} 사용되지 않음 - 바로 삭제`);console.log(`카테고리 ${n.name} 처리 완료`)}catch(o){console.error(`카테고리 ${n.name} 처리 중 오류:`,o);const t=document.getElementById("category-container");t&&(t.appendChild(n.element),t.querySelectorAll(".category-item").forEach((i,u)=>{const a=i.querySelector("p");a&&(a.textContent=`카테고리 ${u+1}`)})),window.showToast(`카테고리 ${n.name} 삭제 중 오류가 발생했습니다.`,3e3,"error")}}function me(){const c=document.getElementById("logoUpload");c&&c.addEventListener("change",fe);const n=document.getElementById("iconUpload");n&&n.addEventListener("change",ye);const o=document.querySelector(".icon-header button");o&&o.addEventListener("click",pe);const s=document.querySelectorAll(".icon-header button")[1];s&&s.addEventListener("click",ge)}function W(c,n,o){return new Promise(t=>{const s=new Image;s.onload=()=>{t(s.width<=n&&s.height<=o)},s.src=URL.createObjectURL(c)})}function K(c){return new Promise((n,o)=>{const t=new FileReader;t.onload=()=>{const i=t.result.split(",")[1];n(i)},t.onerror=o,t.readAsDataURL(c)})}function Q(c){return new Promise((n,o)=>{const t=new FileReader;t.onload=()=>n(t.result),t.onerror=o,t.readAsDataURL(c)})}async function fe(c){var i;const n=(i=c.target.files)==null?void 0:i[0];if(!n)return;if(n.size>2*1024*1024){window.showToast("파일 크기는 2MB 이하여야 합니다.",3e3,"warning");return}if(!await W(n,600,140)){window.showToast("로고 이미지는 600x140 이하여야 합니다.",3e3,"warning");return}k=n,q=await K(n),C=!1;const t=document.getElementById("fileName");t&&(t.textContent=n.name);const s=document.getElementById("logoPreview");if(s){const u=await Q(n);s.src=u,s.style.display="block"}}async function ye(c){var i;const n=(i=c.target.files)==null?void 0:i[0];if(!n)return;if(n.size>2*1024*1024){window.showToast("파일 크기는 2MB 이하여야 합니다.",3e3,"warning");return}if(!await W(n,1300,2e3)){window.showToast("아이콘 이미지는 1300x2000 이하여야 합니다.",3e3,"warning");return}E=n,x=await K(n),N=!1;const t=document.getElementById("iconFileName");t&&(t.textContent=n.name);const s=document.getElementById("iconPreview");if(s){const u=await Q(n);s.src=u,s.style.display="block"}}function pe(){if(!(e!=null&&e.logoUrl)&&!(e!=null&&e.logoBase64))return;k=null,q="",C=!0;const c=document.getElementById("logoUpload");c&&(c.value="");const n=document.getElementById("fileName");n&&(n.textContent="");const o=document.getElementById("logoPreview");o&&(o.src="",o.style.display="none"),e&&(e.logoUrl="",e.logoBase64="")}function ge(){if(!(e!=null&&e.iconUrl)&&!(e!=null&&e.iconBase64))return;E=null,x="",N=!0;const c=document.getElementById("iconUpload");c&&(c.value="");const n=document.getElementById("iconFileName");n&&(n.textContent="");const o=document.getElementById("iconPreview");o&&(o.src="",o.style.display="none"),e&&(e.iconUrl="",e.iconBase64="")}export{ve as initNormalSet};
