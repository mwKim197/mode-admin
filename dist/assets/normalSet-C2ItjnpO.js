import{a as F,g as ee,j as te,k as ne,d as J,e as G,c as oe}from"./main-CRwfewkr.js";let B=null,E=null,q="",x="",b=!1,N=!1,$=[];function Ie(){ae(),ie(),ye(),ce()}function ce(){document.querySelectorAll(".delete-category").forEach(o=>{o.addEventListener("click",()=>R(o))});const n=document.querySelector(".category-actions .btn-outline");n&&n.addEventListener("click",se)}function se(){const c=document.getElementById("category-container");if(!c)return;const n=c.querySelectorAll(".category-item").length;if(n>=9){window.showToast("카테고리는 최대 9개까지 추가할 수 있습니다.",3e3,"warning");return}const o=document.createElement("div");o.className="data_input category-item",o.innerHTML=`
    <p>카테고리${n+1}</p>
    <div class="category-input-group">
      <input type="text"/>
      <button type="button" class="btn-i delete-category">-</button>
    </div>
  `;const t=o.querySelector(".delete-category");t&&t.addEventListener("click",()=>R(t)),c.appendChild(o)}function R(c){var a;if(!document.getElementById("category-container"))return;const o=c.closest(".category-item");if(!o)return;const s=o.querySelector("input").value.trim(),r=(a=e==null?void 0:e.category)==null?void 0:a.find(m=>m.name===s),u=(r==null?void 0:r.item)||s.toLowerCase().replace(/\s+/g,"_");$.push({name:s,item:u,element:o}),o.remove()}function ie(){const c=document.querySelector(".btn-outline");c&&c.addEventListener("click",n=>{n.preventDefault(),me().then(()=>{const o=ee();te(o==null?void 0:o.userId).then(()=>{location.reload()})})})}function re(c){var o;const n=c.config||{};for(const t in n)for(const s in n[t]){const r=(o=n[t][s])==null?void 0:o.name;if(!r)continue;const u=document.querySelector(`input[data-type="${t}"][data-slot="${s}"]`);u&&(u.value=r)}}function _(c,n){var s,r,u;const o=(s=c.inventory)==null?void 0:s[n],t=(u=(r=c.spec)==null?void 0:r.consumption)==null?void 0:u[n];o&&Object.keys(o).forEach(a=>{const m=o[a],d=t==null?void 0:t[a];A(n,a,"current",m.current),A(n,a,"max",m.max),(d==null?void 0:d.perSecond)!==void 0&&A(n,a,"perSecond",d.perSecond)})}function A(c,n,o,t){const s=document.querySelector(`input[data-type="${c}"][data-slot="${n}"][data-field="${o}"]`);s&&(s.value=String(t))}function le(c){var o;const n=(o=c.inventory)==null?void 0:o.cup;n&&Object.keys(n).forEach(t=>{const s=n[t];W(t,"current",s.current),W(t,"max",s.max)})}function W(c,n,o){const t=document.querySelector(`input[data-type="${c}"][data-field="${n}"]`);t&&(t.value=String(o))}async function ue(c){try{const o=await(await F(`/model_inventory_calculate?func=get-runtime&userId=${c}`)).json();o!=null&&o.ok&&o.inventory&&o.spec?(re(o),_(o,"coffee"),_(o,"garucha"),_(o,"syrup"),le(o)):console.warn("⚠️ inventory runtime 없음")}catch(n){console.warn("⚠️ inventory 조회 실패",n)}}let e=null;async function ae(){try{const n=JSON.parse(localStorage.getItem("userInfo")||"{}").userId;if(!n)return;const t=await(await F(`/model_user_setting?func=get-user&userId=${n}`)).json();if(t&&t.user){if(e=t.user,!["model0000","zero16"].includes(e.userId)){const l=document.querySelector("#inventory");l.style.display="none"}e.inventoryCheckEnabled!==!1&&await ue(e.userId);const r=document.getElementById("storeNm");r&&(r.value=t.user.storeName||"");const u=document.querySelector("#tel-input");u&&(u.value=t.user.tel||"");const a=document.getElementById("businessNo");a&&(a.value=t.user.businessNo||"");const m=document.querySelector("#address-input");m&&(m.value=t.user.address||"");const d=document.querySelector('.in-box input[type="text"]');d&&(d.value=t.user.limitCount||"");const g=document.querySelector("#wash-time-input");g&&(g.value=t.user.washTime||"");const v=document.querySelector("#remote-address");v&&(v.value=t.user.remoteAddress||"");const h=document.getElementById("point-check");h&&(h.checked=!t.user.payType);const w=document.getElementById("coupon-check");w&&(w.checked=!t.user.coupon);const I=document.getElementById("vcat-check");I&&(I.checked=t.user.vcat);const p=document.getElementById("inventory-check");if(p&&(p.checked=t.user.inventoryCheckEnabled),de(t.user.category||[]),t.user.logoUrl){const l=document.getElementById("logoPreview");l&&(l.src=t.user.logoUrl,l.style.display="block",l.onerror=()=>{l.style.display="none"})}else if(t.user.logoBase64){const l=document.getElementById("logoPreview");l&&(l.src=t.user.logoBase64,l.style.display="block")}if(t.user.iconUrl){const l=document.getElementById("iconPreview");l&&(l.src=t.user.iconUrl,l.style.display="block",l.onerror=()=>{l.style.display="none"})}else if(t.user.iconBase64){const l=document.getElementById("iconPreview");l&&(l.src=t.user.iconBase64,l.style.display="block")}}}catch{window.showToast("매장 정보 로드에 실패했습니다.",3e3,"error")}}function de(c){const n=document.getElementById("category-container");if(!n)return;n.innerHTML="";const o=(c||[]).filter(t=>t&&t.no!=="0"&&t.item!=="all"&&t.item!=="0");o.length>0&&o.forEach(t=>{const s=String(t.item??""),r=document.createElement("div");r.className="data_input category-item",r.innerHTML=`
        <p>카테고리${s}</p>
        <div class="category-input-group">
          <input type="text" value="${t.name||""}" />
          <button type="button" class="btn-i delete-category">-</button>
        </div>
      `;const u=r.querySelector(".delete-category");u&&u.addEventListener("click",()=>R(u)),n.appendChild(r)})}async function me(){var c;try{const n=JSON.parse(localStorage.getItem("userInfo")||"{}");if(!ne())return;const t=n.userId||"zero001",s=document.querySelector("#storeNm"),r=document.querySelector("#tel-input"),u=document.querySelector("#address-input"),a=document.getElementById("businessNo"),m=document.querySelector("#remote-address"),d=document.querySelector('input[type="password"]'),g=document.getElementById("limit-count"),v=document.getElementById("wash-time-input"),h=document.getElementById("point-check"),w=document.getElementById("coupon-check"),I=document.getElementById("vcat-check"),p=document.getElementById("inventory-check");let l=!1,L=!1,P=!1,S=!1,j=!1;const Y=document.querySelectorAll("#category-container .category-input-group input"),Z=Array.from(Y).map((i,f)=>{var M;const y=i.value.trim();if(!y)return null;const k=(M=e==null?void 0:e.category)==null?void 0:M.find(D=>D.name===y),H=(f+1).toString(),U=(k==null?void 0:k.item)||H;return{name:y,no:H,item:U}}).filter(i=>i!==null),C=[{name:"전체메뉴",no:"0",item:"all"},...Z],z=(e==null?void 0:e.category)||[],V=$.length>0;if(C.length!==z.length||V)S=!0;else for(let i=0;i<C.length;i++){const f=C[i],y=z[i];if(!y||(f==null?void 0:f.name)!==y.name){S=!0;break}}if(s&&s.value!==(e==null?void 0:e.storeName)&&(l=!0),r&&r.value!==(e==null?void 0:e.tel)&&(l=!0),u&&u.value!==(e==null?void 0:e.address)&&(l=!0),a&&a.value!==(e==null?void 0:e.businessNo)&&(l=!0),m&&m.value!==(e==null?void 0:e.remoteAddress)&&(l=!0),v&&v.value!==(e==null?void 0:e.washTime)&&(l=!0),h&&h.checked!==!(e!=null&&e.payType)&&(l=!0),w&&w.checked!==!(e!=null&&e.coupon)&&(l=!0),I&&I.checked!==(e==null?void 0:e.vcat)&&(l=!0),p&&p.checked!==(e==null?void 0:e.inventoryCheckEnabled)&&(l=!0,j=!0),d&&d.value!==""&&d.value!=="******"){if(d.value.length<6){window.showToast("비밀번호는 6자리 이상이어야 합니다.",3e3,"warning");return}L=!0}const T=(g==null?void 0:g.value)||"",O=((c=e==null?void 0:e.limitCount)==null?void 0:c.toString())||"";if(g&&T!==""&&T!==O&&(l=!0),(B||E||b||N)&&(P=!0),!l&&!L&&!P&&!S){window.showToast("변경사항이 없습니다.",3e3,"warning");return}if(l||P||S){V&&await fe(t);const i={userId:t,adminId:t};s&&s.value!==(e==null?void 0:e.storeName)&&(i.storeName=s.value),r&&r.value!==(e==null?void 0:e.tel)&&(i.tel=r.value),u&&u.value!==(e==null?void 0:e.address)&&(i.address=u.value),a&&a.value!==(e==null?void 0:e.businessNo)&&(i.businessNo=a.value),m&&m.value!==(e==null?void 0:e.remoteAddress)&&(i.remoteAddress=m.value),v&&v.value!==(e==null?void 0:e.washTime)&&(i.washTime=v.value),h&&h.checked!==!(e!=null&&e.payType)&&(i.payType=!h.checked),w&&w.checked!==!(e!=null&&e.coupon)&&(i.coupon=!w.checked),I&&I.checked!==(e==null?void 0:e.vcat)&&(i.vcat=I.checked),p&&p.checked!==(e==null?void 0:e.vcat)&&(i.inventoryCheckEnabled=p.checked),g&&T!==""&&T!==O&&(i.limitCount=parseInt(T)),S&&C.length>0&&(i.category=C),B?(i.logoFileName=B.name,i.logoBase64=q):b&&(i.logoFileName="",i.logoBase64="",i.logoUrl=""),E?(i.iconFileName=E.name,i.iconBase64=x):N&&(i.iconFileName="",i.iconBase64="",i.iconUrl="");const f=await J("/model_user_setting?func=update-user",i),y=await f.json();(y.success||y.status==="success"||f.ok)&&await G("/model_machine_controll",{userId:t,func:"update-user"})}if(L){const i=await oe(),f={adminId:i==null?void 0:i.adminId,newPassword:d.value};await J("/model_admin_user?func=update-password",f)}j&&p.checked&&await G("/model_inventory_calculate?func=init-runtime",{userId:e==null?void 0:e.userId}),window.showToast("변경사항이 저장되었습니다.",3e3,"success"),$=[],d&&(d.value="******"),B&&(B=null,q=""),E&&(E=null,x=""),b=!1,N=!1,e&&(b&&(e.logoUrl="",e.logoBase64=""),N&&(e.iconUrl="",e.iconBase64=""),S&&(e.category=C.map((i,f)=>{var y,k;return{...i,item:((k=(y=e==null?void 0:e.category)==null?void 0:y[f])==null?void 0:k.item)||i.name.toLowerCase().replace(/\s+/g,"_")}})))}catch{window.showToast("저장 중 오류가 발생했습니다.",3e3,"error")}}async function fe(c){for(const n of $)try{console.log(`카테고리 ${n.name} 처리 시작`),console.log("전송할 데이터:",{userId:c,category:n.item,categoryName:n.name});const o=await F(`/model_user_setting?func=check-category-usage&userId=${c}&category=${n.item}`);if(console.log("응답:",o.status,o.ok),!o.ok)throw new Error(`카테고리 사용 여부 확인 실패: ${o.status}`);const t=await o.json();if(console.log("결과:",t),t.hasAny){console.log(`카테고리 ${n.name} 사용 중`);const s=await fetch("https://api.narrowroad-model.com/model_user_setting?func=move-category-to-all",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({userId:c,category:n.item})});if(console.log("응답:",s.status,s.ok),!s.ok)throw new Error(`카테고리 이동 실패: ${s.status}`);const r=await s.json();if(console.log("결과:",r),!r.success)throw new Error("카테고리 이동에 실패했습니다.")}else console.log(`카테고리 ${n.name} 사용되지 않음 - 바로 삭제`);console.log(`카테고리 ${n.name} 처리 완료`)}catch(o){console.error(`카테고리 ${n.name} 처리 중 오류:`,o);const t=document.getElementById("category-container");t&&(t.appendChild(n.element),t.querySelectorAll(".category-item").forEach((r,u)=>{const a=r.querySelector("p");a&&(a.textContent=`카테고리 ${u+1}`)})),window.showToast(`카테고리 ${n.name} 삭제 중 오류가 발생했습니다.`,3e3,"error")}}function ye(){const c=document.getElementById("logoUpload");c&&c.addEventListener("change",pe);const n=document.getElementById("iconUpload");n&&n.addEventListener("change",ge);const o=document.querySelector(".icon-header button");o&&o.addEventListener("click",ve);const s=document.querySelectorAll(".icon-header button")[1];s&&s.addEventListener("click",he)}function K(c,n,o){return new Promise(t=>{const s=new Image;s.onload=()=>{t(s.width<=n&&s.height<=o)},s.src=URL.createObjectURL(c)})}function Q(c){return new Promise((n,o)=>{const t=new FileReader;t.onload=()=>{const r=t.result.split(",")[1];n(r)},t.onerror=o,t.readAsDataURL(c)})}function X(c){return new Promise((n,o)=>{const t=new FileReader;t.onload=()=>n(t.result),t.onerror=o,t.readAsDataURL(c)})}async function pe(c){var r;const n=(r=c.target.files)==null?void 0:r[0];if(!n)return;if(n.size>2*1024*1024){window.showToast("파일 크기는 2MB 이하여야 합니다.",3e3,"warning");return}if(!await K(n,600,140)){window.showToast("로고 이미지는 600x140 이하여야 합니다.",3e3,"warning");return}B=n,q=await Q(n),b=!1;const t=document.getElementById("fileName");t&&(t.textContent=n.name);const s=document.getElementById("logoPreview");if(s){const u=await X(n);s.src=u,s.style.display="block"}}async function ge(c){var r;const n=(r=c.target.files)==null?void 0:r[0];if(!n)return;if(n.size>2*1024*1024){window.showToast("파일 크기는 2MB 이하여야 합니다.",3e3,"warning");return}if(!await K(n,1300,2e3)){window.showToast("아이콘 이미지는 1300x2000 이하여야 합니다.",3e3,"warning");return}E=n,x=await Q(n),N=!1;const t=document.getElementById("iconFileName");t&&(t.textContent=n.name);const s=document.getElementById("iconPreview");if(s){const u=await X(n);s.src=u,s.style.display="block"}}function ve(){if(!(e!=null&&e.logoUrl)&&!(e!=null&&e.logoBase64))return;B=null,q="",b=!0;const c=document.getElementById("logoUpload");c&&(c.value="");const n=document.getElementById("fileName");n&&(n.textContent="");const o=document.getElementById("logoPreview");o&&(o.src="",o.style.display="none"),e&&(e.logoUrl="",e.logoBase64="")}function he(){if(!(e!=null&&e.iconUrl)&&!(e!=null&&e.iconBase64))return;E=null,x="",N=!0;const c=document.getElementById("iconUpload");c&&(c.value="");const n=document.getElementById("iconFileName");n&&(n.textContent="");const o=document.getElementById("iconPreview");o&&(o.src="",o.style.display="none"),e&&(e.iconUrl="",e.iconBase64="")}export{Ie as initNormalSet};
