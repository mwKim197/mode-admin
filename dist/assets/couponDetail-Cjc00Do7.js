import{g as x,e as L,a as C}from"./main-B1NCi6Rz.js";function A(){console.log("쿠폰 발행 페이지 초기화"),b(),M();const t=document.getElementById("back-to-list");t&&t.addEventListener("click",function(){window.location.href="/html/couponList.html"});const n=document.getElementById("coupon-form");n&&n.addEventListener("submit",async function(r){var I,D,y,T,v,E,S;r.preventDefault();const o=(I=document.getElementById("franchise-input"))==null?void 0:I.value.trim(),s=(D=document.getElementById("store-input"))==null?void 0:D.value.trim(),e=(y=document.getElementById("device-input"))==null?void 0:y.value.trim(),a=(T=document.getElementById("start-date"))==null?void 0:T.value.trim(),c=(v=document.getElementById("end-date"))==null?void 0:v.value.trim(),u=(E=document.getElementById("issue-count"))==null?void 0:E.value.trim(),d=(S=document.getElementById("sample"))==null?void 0:S.value.trim();if(!o){window.showToast("가맹점을 입력해 주세요",2e3,"warning");return}if(!s){window.showToast("지점을 입력해 주세요",2e3,"warning");return}if(!e){window.showToast("기기번호를 입력해 주세요",2e3,"warning");return}if(!a){window.showToast("사용기한(시작일)을 입력해 주세요",2e3,"warning");return}if(!c){window.showToast("사용기한(종료일)을 입력해 주세요",2e3,"warning");return}if(!u){window.showToast("발행매수를 입력해 주세요",2e3,"warning");return}if(!d){window.showToast("쿠폰을 선택해 주세요",2e3,"warning");return}const i=parseInt(u);if(isNaN(i)||i<1||i>99){window.showToast("발행매수는 1~99개 사이로 입력해주세요",2e3,"warning");return}if(!N(a,c))return;const l=document.getElementById("sample"),f=l==null?void 0:l.options[l.selectedIndex],O=(f==null?void 0:f.textContent)||"";if(confirm("쿠폰을 발행하시겠습니까?"))try{const p=x();if(!p){window.showToast("사용자 정보가 없습니다.",2e3,"error");return}let m=0,g=0;for(let w=0;w<i;w++)try{const h={userId:p.userId,title:`${O} 무료`,menuId:d,count:1,startsAt:a,expiresAt:c},B=await L("/model_coupon?func=setCoupon",h);if(B.ok)m++;else{g++;const $=await B.json();console.error(`쿠폰 발급 실패 (${w+1}/${i}):`,$.message)}}catch(h){g++,console.error(`쿠폰 발급 중 오류 발생 (${w+1}/${i}):`,h)}if(m===i)window.showToast("쿠폰 발행이 완료되었습니다.",3e3,"success");else if(m>0)window.showToast(`${m}개 발급 성공, ${g}개 발급 실패`,3e3,"warning");else{window.showToast("쿠폰 발급에 실패했습니다.",3e3,"error");return}setTimeout(()=>{window.location.href="/html/couponList.html"},1e3)}catch{window.showToast("쿠폰 발급 중 오류가 발생했습니다.",3e3,"error")}})}function N(t,n){if(!t||!n)return window.showToast("시작일과 종료일을 모두 선택해주세요.",3e3,"warning"),!1;const o=new Date().toISOString().split("T")[0],s=new Date(t+"T00:00:00");if(t<o)return window.showToast("시작날짜는 오늘 이후로 설정해주세요.",3e3,"warning"),!1;if(t>n)return window.showToast("시작일은 종료일보다 클 수 없습니다.",3e3,"warning"),!1;const e=new Date(s);e.setDate(e.getDate()+365);const a=e.toISOString().split("T")[0];return n>a?(window.showToast("종료날짜는 시작날짜로부터 1년 이내로 설정해주세요.",3e3,"warning"),!1):!0}async function b(){try{const t=x();if(!t)return;const o=(await(await C(`/model_user_setting?func=get-user&userId=${t.userId}`)).json()).user.storeName,s=document.getElementById("franchise-input"),e=document.getElementById("store-input"),a=document.getElementById("device-input");s&&(s.value=o),e&&(e.value=o),a&&(a.value=t.userId),await j(t.userId)}catch(t){console.error("사용자 데이터 로드 실패:",t)}}async function j(t){try{const r=await(await C(`/model_admin_menu?userId=${t}&func=get-all-menu`)).json(),o=document.getElementById("sample");o&&r.items&&(o.innerHTML='<option value="">쿠폰을 선택해주세요</option>',r.items.forEach(s=>{if(!s.menuId||!s.name)return;const e=document.createElement("option");e.value=s.menuId,e.textContent=s.name,o.appendChild(e)}),new window.Choices(o,{shouldSort:!1,searchEnabled:!0,position:"auto",classNames:{containerOuter:"custom-select",containerInner:"custom-select-inner",input:"custom-select-input",itemChoice:"custom-select-item",listDropdown:"custom-select-dropdown",placeholder:"custom-select-placeholder"}}))}catch(n){console.error("메뉴 데이터 로드 실패:",n)}}function M(){const t=document.getElementById("start-date"),n=document.getElementById("end-date");if(!t||!n){console.error("날짜 입력 필드를 찾을 수 없습니다.");return}const r=new Date().toISOString().split("T")[0];t.min=r,t.value=r,n.min=r,t.addEventListener("change",function(){const o=this.value;if(o){const s=new Date(o),e=new Date(s);e.setDate(e.getDate()+365);const a=e.toISOString().split("T")[0];n.max=a,n.value&&n.value>a&&(n.value=a),n.min=o}}),n.addEventListener("change",function(){const o=this.value;if(o){const s=new Date(o),e=new Date(s);e.setDate(e.getDate()-365);const a=e.toISOString().split("T")[0],c=new Date(r).getTime(),u=new Date(a).getTime(),d=Math.max(c,u);t.min=new Date(d).toISOString().split("T")[0]}})}export{A as initCouponDetail};
