import{a as O,g as te,j as ne,k as oe,d as F,e as W,c as ce}from"./main-C2NTl3Dy.js";let k=null,E=null,x="",L="",b=!1,C=!1,q=[];function qe(){fe(),le(),ke(),ie(),se()}function se(){function s(n){n.addEventListener("input",()=>{const i=n.value.replace(/[^0-9]/g,"");i!==n.value&&(n.value=i)})}function e(n){n.addEventListener("input",()=>{let i=n.value.replace(/[^0-9.]/g,"");const l=i.split(".");l.length>2&&(i=l.shift()+"."+l.join("")),i!==n.value&&(n.value=i)})}function t(n,i,l){n.addEventListener("input",()=>{const u=Number(n.value||0);Number.isFinite(u)&&u>i&&(n.value=String(i),window.showToast(`${l}의 최대값은 ${i} 입니다. 최대값으로 조정했습니다.`,3e3,"warning"))})}function c(n,i){const l=()=>{const u=Number(n.value||0),d=Number(i.value||0);!Number.isFinite(u)||!Number.isFinite(d)||d>0&&u>d&&(n.value=String(d),window.showToast("현재중량은 최대값을 초과할 수 없습니다. 최대값으로 조정했습니다.",3e3,"warning"))};n.addEventListener("input",()=>{s(n),l()}),i.addEventListener("input",()=>{s(i),l()})}document.querySelectorAll('#inventory input[data-field="current"]').forEach(n=>{const i=n.dataset.type,l=n.dataset.slot;let u=`#inventory input[data-field="max"][data-type="${i}"]`;l&&(u+=`[data-slot="${l}"]`);const d=document.querySelector(u);if(d)s(n),s(d),c(n,d);else{const m=`#inventory input[data-field="max"][data-type="${i}"]`,y=document.querySelector(m);y&&(s(n),s(y),c(n,y))}}),document.querySelectorAll('#inventory input[data-field="max"]').forEach(n=>{s(n),t(n,3e3,"최대값")}),document.querySelectorAll('#inventory input[data-field="perSecond"]').forEach(n=>{e(n),t(n,50,"초당 사용량")}),document.querySelectorAll('#inventory input[data-field="name"]').forEach(n=>{n.maxLength=100,n.addEventListener("input",()=>{n.value.length>100&&(n.value=n.value.slice(0,100),window.showToast("이름은 100자 미만으로 입력해 주세요. 초과분을 잘라냈습니다.",3e3,"warning"))})})}function ie(){document.querySelectorAll(".delete-category").forEach(t=>{t.addEventListener("click",()=>j(t))});const e=document.querySelector(".category-actions .btn-outline");e&&e.addEventListener("click",re)}function re(){const s=document.getElementById("category-container");if(!s)return;const e=s.querySelectorAll(".category-item").length;if(e>=9){window.showToast("카테고리는 최대 9개까지 추가할 수 있습니다.",3e3,"warning");return}const t=document.createElement("div");t.className="data_input category-item",t.innerHTML=`
    <p>카테고리${e+1}</p>
    <div class="category-input-group">
      <input type="text"/>
      <button type="button" class="btn-i delete-category">-</button>
    </div>
  `;const c=t.querySelector(".delete-category");c&&c.addEventListener("click",()=>j(c)),s.appendChild(t)}function j(s){var u;if(!document.getElementById("category-container"))return;const t=s.closest(".category-item");if(!t)return;const n=t.querySelector("input").value.trim(),i=(u=o==null?void 0:o.category)==null?void 0:u.find(d=>d.name===n),l=(i==null?void 0:i.item)||n.toLowerCase().replace(/\s+/g,"_");q.push({name:n,item:l,element:t}),t.remove()}function le(){const s=document.querySelector(".btn-outline");s&&s.addEventListener("click",e=>{e.preventDefault(),we().then(()=>{const t=te();ne(t==null?void 0:t.userId).then(()=>{location.reload()})})})}function ue(s){var t;const e=s.config||{};for(const c in e)for(const n in e[c]){const i=(t=e[c][n])==null?void 0:t.name;if(!i)continue;const l=document.querySelector(`input[data-type="${c}"][data-slot="${n}"]`);l&&(l.value=i)}}function A(s,e){var n,i,l;const t=(n=s.inventory)==null?void 0:n[e],c=(l=(i=s.spec)==null?void 0:i.consumption)==null?void 0:l[e];t&&Object.keys(t).forEach(u=>{const d=t[u],m=c==null?void 0:c[u];P(e,u,"current",d.current),P(e,u,"max",d.max),(m==null?void 0:m.perSecond)!==void 0&&P(e,u,"perSecond",m.perSecond)})}function P(s,e,t,c){const n=document.querySelector(`input[data-type="${s}"][data-slot="${e}"][data-field="${t}"]`);n&&(n.value=String(c))}function ae(s){var t;const e=(t=s.inventory)==null?void 0:t.cup;e&&Object.keys(e).forEach(c=>{const n=e[c];K(c,"current",n.current),K(c,"max",n.max)})}function K(s,e,t){const c=document.querySelector(`input[data-type="${s}"][data-field="${e}"]`);c&&(c.value=String(t))}function de(s){var c;const e=((c=s.flags)==null?void 0:c.soldOut)||{};document.querySelectorAll('input[data-field="soldOut"]').forEach(n=>{const i=n.dataset.type,l=n.dataset.slot;if(!i)return;const u=l?`${i}_${l}`:`cup_${i}`;n.checked=!!e[u]})}async function me(s){try{const t=await(await O(`/model_inventory_calculate?func=get-runtime&userId=${s}`)).json();t!=null&&t.ok&&t.inventory&&t.spec?(ue(t),A(t,"coffee"),A(t,"garucha"),A(t,"syrup"),de(t),ae(t)):console.warn("⚠️ inventory runtime 없음")}catch(e){console.warn("⚠️ inventory 조회 실패",e)}}let o=null;async function fe(){try{const e=JSON.parse(localStorage.getItem("userInfo")||"{}").userId;if(!e)return;const c=await(await O(`/model_user_setting?func=get-user&userId=${e}`)).json();if(c&&c.user){if(o=c.user,!["model0000","zero16"].includes(o.userId)){const a=document.querySelector("#inventory");a.style.display="none"}o.inventoryCheckEnabled!==!1&&await me(o.userId);const i=document.getElementById("storeNm");i&&(i.value=c.user.storeName||"");const l=document.querySelector("#tel-input");l&&(l.value=c.user.tel||"");const u=document.getElementById("businessNo");u&&(u.value=c.user.businessNo||"");const d=document.querySelector("#address-input");d&&(d.value=c.user.address||"");const m=document.querySelector('.in-box input[type="text"]');m&&(m.value=c.user.limitCount||"");const y=document.querySelector("#wash-time-input");y&&(y.value=c.user.washTime||"");const g=document.querySelector("#remote-address");g&&(g.value=c.user.remoteAddress||"");const h=document.getElementById("point-check");h&&(h.checked=!c.user.payType);const w=document.getElementById("coupon-check");w&&(w.checked=!c.user.coupon);const I=document.getElementById("vcat-check");I&&(I.checked=c.user.vcat);const S=document.getElementById("inventory-check");if(S&&(S.checked=c.user.inventoryCheckEnabled),ye(c.user.category||[]),c.user.logoUrl){const a=document.getElementById("logoPreview");a&&(a.src=c.user.logoUrl,a.style.display="block",a.onerror=()=>{a.style.display="none"})}else if(c.user.logoBase64){const a=document.getElementById("logoPreview");a&&(a.src=c.user.logoBase64,a.style.display="block")}if(c.user.iconUrl){const a=document.getElementById("iconPreview");a&&(a.src=c.user.iconUrl,a.style.display="block",a.onerror=()=>{a.style.display="none"})}else if(c.user.iconBase64){const a=document.getElementById("iconPreview");a&&(a.src=c.user.iconBase64,a.style.display="block")}}}catch{window.showToast("매장 정보 로드에 실패했습니다.",3e3,"error")}}function ye(s){const e=document.getElementById("category-container");if(!e)return;e.innerHTML="";const t=(s||[]).filter(c=>c&&c.no!=="0"&&c.item!=="all"&&c.item!=="0");t.length>0&&t.forEach((c,n)=>{const i=String(c.item??""),l=String(c.no??String(n+1)),u=document.createElement("div");u.className="data_input category-item",u.innerHTML=`
        <p>카테고리${l}</p>
        <div class="category-input-group">
          <input type="text" />
          <button type="button" class="btn-i delete-category">-</button>
        </div>
      `;const d=u.querySelector("input");d.value=c.name||"",d.dataset.originalItem=i,d.dataset.originalNo=l;const m=u.querySelector(".delete-category");m&&m.addEventListener("click",()=>j(m)),e.appendChild(u)})}function pe(){const s={};return document.querySelectorAll('#inventory input[data-field="current"], #inventory input[data-field="max"]').forEach(e=>{const t=e.dataset.type,c=e.dataset.slot,n=e.dataset.field,i=Number(e.value||0);if(t==="paper"||t==="plastic"){s.cup=s.cup||{},s.cup[t]=s.cup[t]||{},s.cup[t][n]=i;return}s[t]=s[t]||{},s[t][c]=s[t][c]||{},s[t][c][n]=i}),s}function ve(){const s={};return document.querySelectorAll('#inventory input[type="checkbox"][data-field="soldOut"]').forEach(e=>{const t=e.dataset.type,c=e.dataset.slot,n=c?`${t}_${c}`:`cup_${t}`;e.checked?s[n]=!0:s[n]=!1}),s}function ge(){const s={consumption:{}};return document.querySelectorAll('#inventory input[data-field="perSecond"]').forEach(e=>{const t=e.dataset.type,c=e.dataset.slot,n=Number(e.value);Number.isNaN(n)||(s.consumption[t]||(s.consumption[t]={}),s.consumption[t][c]={perSecond:n})}),s}function he(){const s={};return document.querySelectorAll('#inventory input[data-field="name"]').forEach(e=>{const t=e.dataset.type,c=e.dataset.slot,n=e.value.trim();n&&(s[t]||(s[t]={}),s[t][c]={name:n})}),s}async function we(){var s;try{let e=function(r){return(r||[]).map(f=>({no:String(f.no??""),name:String(f.name??""),item:String(f.item??"")})).sort((f,v)=>Number(f.no)-Number(v.no))};const t=JSON.parse(localStorage.getItem("userInfo")||"{}");if(!oe())return;const n=t.userId||"zero001",i=document.querySelector("#storeNm"),l=document.querySelector("#tel-input"),u=document.querySelector("#address-input"),d=document.getElementById("businessNo"),m=document.querySelector("#remote-address"),y=document.querySelector('input[type="password"]'),g=document.getElementById("limit-count"),h=document.getElementById("wash-time-input"),w=document.getElementById("point-check"),I=document.getElementById("coupon-check"),S=document.getElementById("vcat-check"),a=document.getElementById("inventory-check");let p=!1,R=!1,V=!1,T=!1,z=!1;const Z=document.querySelectorAll("#category-container .category-input-group input"),M=Array.from(Z).map((r,f)=>{const v=r,B=v.value.trim();if(!B)return null;const G=String(f+1),D=G,ee=v.dataset.originalItem||"";return{name:B,no:G,item:D,originalItem:ee}}).filter(Boolean),$=[{name:"전체메뉴",no:"0",item:"all"},...M.map(({name:r,no:f,item:v})=>({name:r,no:f,item:v}))],_={all:"all"};for(const r of M)r.originalItem&&(_[r.originalItem]=r.item);for(const r of q){const f=String((r==null?void 0:r.item)??"");f&&(_[f]="all")}const U=(o==null?void 0:o.category)||[],H=q.length>0;if(T=H||JSON.stringify(e($))!==JSON.stringify(e(U)),i&&i.value!==(o==null?void 0:o.storeName)&&(p=!0),l&&l.value!==(o==null?void 0:o.tel)&&(p=!0),u&&u.value!==(o==null?void 0:o.address)&&(p=!0),d&&d.value!==(o==null?void 0:o.businessNo)&&(p=!0),m&&m.value!==(o==null?void 0:o.remoteAddress)&&(p=!0),h&&h.value!==(o==null?void 0:o.washTime)&&(p=!0),w&&w.checked!==!(o!=null&&o.payType)&&(p=!0),I&&I.checked!==!(o!=null&&o.coupon)&&(p=!0),S&&S.checked!==(o==null?void 0:o.vcat)&&(p=!0),a&&a.checked!==(o==null?void 0:o.inventoryCheckEnabled)&&(p=!0,z=!0),y&&y.value!==""&&y.value!=="******"){if(y.value.length<6){window.showToast("비밀번호는 6자리 이상이어야 합니다.",3e3,"warning");return}R=!0}const N=(g==null?void 0:g.value)||"",J=((s=o==null?void 0:o.limitCount)==null?void 0:s.toString())||"";if(g&&N!==""&&N!==J&&(p=!0),(k||E||b||C)&&(V=!0),p||V||T){H&&await Se(n);const r={userId:n,adminId:n};i&&i.value!==(o==null?void 0:o.storeName)&&(r.storeName=i.value),l&&l.value!==(o==null?void 0:o.tel)&&(r.tel=l.value),u&&u.value!==(o==null?void 0:o.address)&&(r.address=u.value),d&&d.value!==(o==null?void 0:o.businessNo)&&(r.businessNo=d.value),m&&m.value!==(o==null?void 0:o.remoteAddress)&&(r.remoteAddress=m.value),h&&h.value!==(o==null?void 0:o.washTime)&&(r.washTime=h.value),w&&w.checked!==!(o!=null&&o.payType)&&(r.payType=!w.checked),I&&I.checked!==!(o!=null&&o.coupon)&&(r.coupon=!I.checked),S&&S.checked!==(o==null?void 0:o.vcat)&&(r.vcat=S.checked),a&&a.checked!==(o==null?void 0:o.vcat)&&(r.inventoryCheckEnabled=a.checked),g&&N!==""&&N!==J&&(r.limitCount=parseInt(N)),T&&$.length>0&&(r.category=$,r.categoryItemMap=_),k?(r.logoFileName=k.name,r.logoBase64=x):b&&(r.logoFileName="",r.logoBase64="",r.logoUrl=""),E?(r.iconFileName=E.name,r.iconBase64=L):C&&(r.iconFileName="",r.iconBase64="",r.iconUrl="");const f=await F("/model_user_setting?func=update-user",r),v=await f.json();(v.success||v.status==="success"||f.ok)&&await W("/model_machine_controll",{userId:n,func:"update-user"})}if(R){const r=await ce(),f={adminId:r==null?void 0:r.adminId,newPassword:y.value};await F("/model_admin_user?func=update-password",f)}z&&a.checked&&await W("/model_inventory_calculate?func=init-runtime",{userId:o==null?void 0:o.userId}),await Ie(t.userId),window.showToast("변경사항이 저장되었습니다.",3e3,"success"),q=[],y&&(y.value="******"),k&&(k=null,x=""),E&&(E=null,L=""),b=!1,C=!1,o&&(b&&(o.logoUrl="",o.logoBase64=""),C&&(o.iconUrl="",o.iconBase64=""),T&&(o.category=$.map((r,f)=>{var v,B;return{...r,item:((B=(v=o==null?void 0:o.category)==null?void 0:v[f])==null?void 0:B.item)||r.name.toLowerCase().replace(/\s+/g,"_")}})))}catch{window.showToast("저장 중 오류가 발생했습니다.",3e3,"error")}}async function Ie(s){const e=pe(),t=ge(),c=he(),n=ve();await F("/model_inventory_calculate?func=update-config",{userId:s,inventory:e,spec:t,config:c,soldOut:n})}async function Se(s){for(const e of q)try{console.log(`카테고리 ${e.name} 처리 시작`),console.log("전송할 데이터:",{userId:s,category:e.item,categoryName:e.name});const t=await O(`/model_user_setting?func=check-category-usage&userId=${s}&category=${e.item}`);if(console.log("응답:",t.status,t.ok),!t.ok)throw new Error(`카테고리 사용 여부 확인 실패: ${t.status}`);const c=await t.json();if(console.log("결과:",c),c.hasAny){console.log(`카테고리 ${e.name} 사용 중`);const n=await fetch("https://api.narrowroad-model.com/model_user_setting?func=move-category-to-all",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({userId:s,category:e.item})});if(console.log("응답:",n.status,n.ok),!n.ok)throw new Error(`카테고리 이동 실패: ${n.status}`);const i=await n.json();if(console.log("결과:",i),!i.success)throw new Error("카테고리 이동에 실패했습니다.")}else console.log(`카테고리 ${e.name} 사용되지 않음 - 바로 삭제`);console.log(`카테고리 ${e.name} 처리 완료`)}catch(t){console.error(`카테고리 ${e.name} 처리 중 오류:`,t);const c=document.getElementById("category-container");c&&(c.appendChild(e.element),c.querySelectorAll(".category-item").forEach((i,l)=>{const u=i.querySelector("p");u&&(u.textContent=`카테고리 ${l+1}`)})),window.showToast(`카테고리 ${e.name} 삭제 중 오류가 발생했습니다.`,3e3,"error")}}function ke(){const s=document.getElementById("logoUpload");s&&s.addEventListener("change",Ee);const e=document.getElementById("iconUpload");e&&e.addEventListener("change",Be);const t=document.querySelector(".icon-header button");t&&t.addEventListener("click",be);const n=document.querySelectorAll(".icon-header button")[1];n&&n.addEventListener("click",Ce)}function Q(s,e,t){return new Promise(c=>{const n=new Image;n.onload=()=>{c(n.width<=e&&n.height<=t)},n.src=URL.createObjectURL(s)})}function X(s){return new Promise((e,t)=>{const c=new FileReader;c.onload=()=>{const i=c.result.split(",")[1];e(i)},c.onerror=t,c.readAsDataURL(s)})}function Y(s){return new Promise((e,t)=>{const c=new FileReader;c.onload=()=>e(c.result),c.onerror=t,c.readAsDataURL(s)})}async function Ee(s){var i;const e=(i=s.target.files)==null?void 0:i[0];if(!e)return;if(e.size>2*1024*1024){window.showToast("파일 크기는 2MB 이하여야 합니다.",3e3,"warning");return}if(!await Q(e,600,140)){window.showToast("로고 이미지는 600x140 이하여야 합니다.",3e3,"warning");return}k=e,x=await X(e),b=!1;const c=document.getElementById("fileName");c&&(c.textContent=e.name);const n=document.getElementById("logoPreview");if(n){const l=await Y(e);n.src=l,n.style.display="block"}}async function Be(s){var i;const e=(i=s.target.files)==null?void 0:i[0];if(!e)return;if(e.size>2*1024*1024){window.showToast("파일 크기는 2MB 이하여야 합니다.",3e3,"warning");return}if(!await Q(e,1300,2e3)){window.showToast("아이콘 이미지는 1300x2000 이하여야 합니다.",3e3,"warning");return}E=e,L=await X(e),C=!1;const c=document.getElementById("iconFileName");c&&(c.textContent=e.name);const n=document.getElementById("iconPreview");if(n){const l=await Y(e);n.src=l,n.style.display="block"}}function be(){if(!(o!=null&&o.logoUrl)&&!(o!=null&&o.logoBase64))return;k=null,x="",b=!0;const s=document.getElementById("logoUpload");s&&(s.value="");const e=document.getElementById("fileName");e&&(e.textContent="");const t=document.getElementById("logoPreview");t&&(t.src="",t.style.display="none"),o&&(o.logoUrl="",o.logoBase64="")}function Ce(){if(!(o!=null&&o.iconUrl)&&!(o!=null&&o.iconBase64))return;E=null,L="",C=!0;const s=document.getElementById("iconUpload");s&&(s.value="");const e=document.getElementById("iconFileName");e&&(e.textContent="");const t=document.getElementById("iconPreview");t&&(t.src="",t.style.display="none"),o&&(o.iconUrl="",o.iconBase64="")}export{qe as initNormalSet};
