<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>카카오 로그인 처리</title>
  <script>
    (function () {
      const params = new URLSearchParams(location.search);
      const code  = params.get("code");
      const state = params.get("state");                // ✅ CSRF용 state
      const error = params.get("error") || params.get("error_description");

      const origin = location.origin;                   // "https://zeroadmin.kr"

      // 팝업 플로우
      if (window.opener && !window.opener.closed) {
        const payload = { type: "kakao-auth", code, state, error };
        window.opener.postMessage(payload, origin);     // ✅ type/ state 포함
        window.close();
        return;
      }

      // 모바일/리다이렉트 플로우
      if (error || !code) {
        alert("카카오 로그인에 실패했습니다.");
        location.href = "/html/log.html";
        return;
      }

      // 서버 토큰 교환
      fetch("https://api.narrowroad-model.com/model_admin_login?func=kakao-login", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ code, state }),          // ✅ state 함께 전달(선택)
      })
              .then(r => r.json())
              .then(result => {
                if (result.accessToken) {
                  localStorage.setItem("accessToken", result.accessToken);
                  location.href = "/html/home.html";
                } else if (result.redirectUrl) {
                  location.href = result.redirectUrl;
                } else {
                  alert("카카오 로그인 실패. 다시 시도하세요.");
                  location.href = "/html/log.html";
                }
              })
              .catch(err => {
                console.error("❌ 로그인 오류:", err);
                alert("서버 오류가 발생했습니다. 다시 시도하세요.");
                location.href = "/html/log.html";
              });
    })();
  </script>
</head>
<body style="background-color:#000;color:#fff;">
<h1>카카오 로그인 중...</h1>
</body>
</html>
